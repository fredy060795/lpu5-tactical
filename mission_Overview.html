<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MISSION OVERVIEW</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --panel-bg: #1a1a1a;
            --border-color: #333;
            --text-main: #d0d0d0;
            --accent-blue: #ffffff;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --tactical-gray: #2d2d2d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Courier New', monospace;
            overflow-x: hidden;
        }

        header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-bottom: 2px solid var(--accent-blue);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.35);
        }

        h1 {
            color: var(--accent-blue);
            font-size: 1.5em;
            margin: 0;
        }

        .container {
            padding: 20px;
            max-width: 960px;
            margin: 0 auto;
        }

        /* ===== SIDEBAR LAYOUT ===== */
        #pageLayout {
            display: flex;
            height: calc(100vh - 57px);
            overflow: hidden;
        }

        #sidebar {
            width: 260px;
            min-width: 220px;
            flex-shrink: 0;
            background: #111;
            border-right: 1px solid #333;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        #sidebarHeader {
            padding: 12px;
            border-bottom: 1px solid #333;
            background: #1a1a1a;
        }

        #sidebarHeader h3 {
            color: #ccc;
            font-size: 0.85em;
            text-transform: uppercase;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        #toggleCompleted {
            width: 100%;
            padding: 6px 10px;
            background: #2a2a2a;
            border: 1px solid #444;
            color: #aaa;
            font-size: 0.72em;
            cursor: pointer;
            border-radius: 4px;
            font-family: 'Courier New', monospace;
            text-transform: uppercase;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.15s;
        }

        #toggleCompleted:hover { background: #333; color: #fff; }

        #missionList {
            flex: 1;
            overflow-y: auto;
        }

        .mission-item {
            padding: 10px 14px;
            cursor: pointer;
            border-bottom: 1px solid #1a1a1a;
            border-left: 3px solid transparent;
            transition: background 0.15s;
        }

        .mission-item:hover { background: #1a1a1a; }
        .mission-item.active { background: #1e1e1e; border-left-color: #fff; }

        .mi-date { color: #777; font-size: 0.72em; margin-bottom: 2px; }
        .mi-obj  { color: #ddd; font-size: 0.83em; font-weight: bold; margin-bottom: 3px; }
        .mi-status { font-size: 0.7em; }
        .mi-status-ongoing { color: #ffaa00; }
        .mi-status-success { color: #00ff00; }
        .mi-status-failed  { color: #ff0000; }

        #mainWrap {
            flex: 1;
            overflow-y: auto;
        }

        .order-section {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 18px;
        }

        .order-section h2 {
            color: var(--accent-blue);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .field-row {
            margin-bottom: 12px;
        }

        .field-label {
            color: #888;
            text-transform: uppercase;
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .field-value {
            background: #000;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            color: #fff;
            min-height: 36px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .field-value.empty {
            color: #555;
            font-style: italic;
        }

        .status-ONGOING { color: #ffaa00; font-weight: bold; }
        .status-SUCCESS { color: #00ff00; font-weight: bold; }
        .status-FAILED  { color: #ff0000; font-weight: bold; }

        .meta-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 6px;
            font-size: 0.9em;
            color: #aaa;
        }

        .meta-bar span strong {
            color: var(--text-main);
        }

        .loading-msg, .error-msg {
            text-align: center;
            padding: 40px;
            color: #888;
            font-style: italic;
        }

        .error-msg { color: var(--accent-red); }

        .attachment-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }

        .attachment-thumb {
            border: 1px solid #333;
            border-radius: 6px;
            overflow: hidden;
            background: #000;
            max-width: 200px;
            text-align: center;
        }

        .attachment-thumb img {
            width: 100%;
            max-height: 150px;
            object-fit: cover;
            display: block;
        }

        .attachment-label {
            font-size: 0.75em;
            color: #888;
            padding: 4px 6px;
            word-break: break-all;
        }

        .attachment-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #111;
            border: 1px solid #333;
            border-radius: 4px;
            color: #aaa;
            text-decoration: none;
            font-size: 0.85em;
        }

        .attachment-link:hover { color: #fff; }

        .attachment-pdf-wrap {
            width: 100%;
            border: 1px solid #333;
            border-radius: 6px;
            overflow: hidden;
            background: #000;
            margin-bottom: 4px;
        }

        .attachment-pdf-wrap embed {
            display: block;
            width: 100%;
            height: 420px;
        }

        @media (max-width: 768px) {
            header { padding: 12px 16px; }
            h1 { font-size: 1.1em; }
            .container { padding: 12px; }
            #pageLayout { flex-direction: column; height: auto; overflow: visible; }
            #sidebar { width: 100%; min-width: unset; height: auto; max-height: 220px; border-right: none; border-bottom: 1px solid #333; }
            #mainWrap { overflow-y: visible; }
        }
    </style>
</head>
<body>

<header>
    <i class="fas fa-scroll" style="font-size:1.4em;"></i>
    <h1>MISSION OVERVIEW &mdash; <span id="headerTitle">...</span></h1>
</header>

<div id="pageLayout">
    <aside id="sidebar">
        <div id="sidebarHeader">
            <h3><i class="fas fa-list"></i> Missions</h3>
            <button id="toggleCompleted" onclick="toggleShowCompleted()">
                <i class="fas fa-filter"></i> Show completed
            </button>
        </div>
        <div id="missionList">
            <p style="padding:14px;color:#666;font-size:0.8em;">Loading...</p>
        </div>
    </aside>
    <div id="mainWrap">
        <div class="container" id="mainContent">
            <p class="loading-msg"><i class="fas fa-spinner fa-spin"></i> Mission order loading...</p>
        </div>
    </div>
</div>

<script>
    let showCompleted = false;
    let allMissions = [];

    function getMissionId() {
        const params = new URLSearchParams(window.location.search);
        return params.get('id');
    }

    function val(v) {
        if (v === null || v === undefined || String(v).trim() === '') {
            return '<span class="empty">—</span>';
        }
        return String(v)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#x27;');
    }

    function section(icon, title, rows) {
        const rowsHtml = rows.map(([label, value]) => `
            <div class="field-row">
                <div class="field-label">${label}</div>
                <div class="field-value">${val(value)}</div>
            </div>
        `).join('');
        return `
            <div class="order-section">
                <h2><i class="${icon}"></i> ${title}</h2>
                ${rowsHtml}
            </div>
        `;
    }

    // ===== SIDEBAR =====
    async function loadMissionList() {
        try {
            const res = await fetch('/api/missions');
            if (!res.ok) return;
            allMissions = await res.json();
            renderMissionList();
        } catch (e) { console.warn('Sidebar load error:', e); }
    }

    function renderMissionList() {
        const list = document.getElementById('missionList');
        const currentId = getMissionId();
        const filtered = showCompleted ? allMissions : allMissions.filter(m => m.status === 'ONGOING');

        if (!filtered || filtered.length === 0) {
            list.innerHTML = '<p style="padding:14px;color:#666;font-size:0.8em;font-style:italic;">No missions available.</p>';
            return;
        }

        list.innerHTML = filtered.map(m => {
            const isActive = String(m.id) === String(currentId);
            const statusCls = m.status === 'ONGOING' ? 'mi-status-ongoing' : m.status === 'SUCCESS' ? 'mi-status-success' : 'mi-status-failed';
            return `<div class="mission-item${isActive ? ' active' : ''}" onclick="selectMission('${m.id}')">
                <div class="mi-date">${m.date || '—'}</div>
                <div class="mi-obj">${m.objective || m.name || m.id}</div>
                <div class="mi-status ${statusCls}">${m.status || '—'}</div>
            </div>`;
        }).join('');
    }

    function selectMission(id) {
        const url = new URL(window.location);
        url.searchParams.set('id', id);
        window.history.pushState({}, '', url);
        loadOrder();
        renderMissionList();
    }

    function toggleShowCompleted() {
        showCompleted = !showCompleted;
        const btn = document.getElementById('toggleCompleted');
        btn.innerHTML = showCompleted
            ? '<i class="fas fa-filter"></i> Hide completed'
            : '<i class="fas fa-filter"></i> Show completed';
        renderMissionList();
    }

    // ===== ORDER VIEW =====
    async function loadOrder() {
        const id = getMissionId();
        const content = document.getElementById('mainContent');

        if (!id) {
            content.innerHTML = '<p class="error-msg"><i class="fas fa-exclamation-triangle"></i> No mission selected. Please click a mission on the left.</p>';
            return;
        }

        content.innerHTML = '<p class="loading-msg"><i class="fas fa-spinner fa-spin"></i> Mission order loading...</p>';

        try {
            const res = await fetch(`/api/mission_details/${id}`);
            if (!res.ok) throw new Error(`HTTP ${res.status} – ${res.statusText || 'Error loading'}`);
            const m = await res.json();

            document.getElementById('headerTitle').textContent = m.objective || m.name || id;
            document.title = 'OVERVIEW – ' + (m.objective || id);

            const d = m.data || {};
            const statusClass = `status-${m.status || 'ONGOING'}`;

            const metaBar = `
                <div class="order-section">
                    <h2><i class="fas fa-bullseye"></i> Mission Overview</h2>
                    <div class="meta-bar">
                        <span><strong>Date:</strong> ${val(d.date || m.date)}</span>
                        <span><strong>AO:</strong> ${val(d.location || m.location)}</span>
                        <span><strong>Start:</strong> ${val(d.start_time)}</span>
                        <span><strong>End:</strong> ${val(d.deadline)}</span>
                        <span><strong>Status:</strong> <span class="${statusClass}">${m.status || '—'}</span></span>
                    </div>
                </div>
            `;

            const gesamtbefehl = section(
                'fas fa-file-alt', 'Operations Order',
                [['Operations Order', d.gesamtbefehl]]
            );

            const lage = `
                <div class="order-section">
                    <h2><i class="fas fa-map-marked-alt"></i> Situation</h2>
                    <div class="field-row">
                        <div class="field-label">Enemy</div>
                        <div class="field-value">${val(d.lage_feind)}</div>
                    </div>
                    <div class="field-row">
                        <div class="field-label">Friendly Forces</div>
                        <div class="field-value">${val(d.lage_eigene)}</div>
                    </div>
                    <div class="field-row">
                        <div class="field-label">Attachments / Detachments</div>
                        <div class="field-value">${val(d.lage_unterstellungen)}</div>
                    </div>
                </div>
            `;

            const auftrag = section(
                'fas fa-crosshairs', 'Mission',
                [['Mission', d.auftrag]]
            );

            const durchfuehrung = `
                <div class="order-section">
                    <h2><i class="fas fa-chess-knight"></i> Execution</h2>
                    <div class="field-row">
                        <div class="field-label">How?</div>
                        <div class="field-value">${val(d.durchf_wie)}</div>
                    </div>
                    <div class="field-row">
                        <div class="field-label">Plan</div>
                        <div class="field-value">${val(d.durchf_plan)}</div>
                    </div>
                    <div class="field-row">
                        <div class="field-label">Coordination</div>
                        <div class="field-value">${val(d.durchf_koordination)}</div>
                    </div>
                </div>
            `;

            const versorgung = `
                <div class="order-section">
                    <h2><i class="fas fa-box-open"></i> Service &amp; Support</h2>
                    <div class="field-row">
                        <div class="field-label">Break times and conduct</div>
                        <div class="field-value">${val(d.vers_pausenzeiten)}</div>
                    </div>
                    <div class="field-row">
                        <div class="field-label">Rations</div>
                        <div class="field-value">${val(d.vers_verpflegung)}</div>
                    </div>
                </div>
            `;

            const verbindung = `
                <div class="order-section">
                    <h2><i class="fas fa-radio"></i> Command &amp; Signal</h2>
                    <div class="field-row">
                        <div class="field-label">Channels / Check!</div>
                        <div class="field-value">${val(d.verb_kanaele)}</div>
                    </div>
                    <div class="field-row">
                        <div class="field-label">Group Names</div>
                        <div class="field-value">${val(d.verb_gruppen)}</div>
                    </div>
                    <div class="field-row">
                        <div class="field-label">Command – Where?</div>
                        <div class="field-value">${val(d.verb_kdo_wo)}</div>
                    </div>
                </div>
            `;

            // Build attachments section with inline previews
            const attachments = d.attachments || [];
            let attachmentsHtml = '';
            if (attachments.length > 0) {
                const items = attachments.map(a => {
                    const isImage = /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(a.url);
                    const isPdf = /\.pdf$/i.test(a.url);
                    if (isImage) {
                        return `<div class="attachment-thumb">
                            <a href="${val(a.url)}" target="_blank">
                                <img src="${val(a.url)}" alt="${val(a.original_name)}">
                            </a>
                            <div class="attachment-label">${val(a.original_name)}</div>
                        </div>`;
                    }
                    if (isPdf) {
                        return `<div class="attachment-pdf-wrap" style="width:100%;">
                            <embed src="${val(a.url)}" type="application/pdf" title="${val(a.original_name)}">
                            <div class="attachment-label">
                                <a href="${val(a.url)}" target="_blank" style="color:#aaa;">
                                    <i class="fas fa-external-link-alt"></i> ${val(a.original_name)}
                                </a>
                            </div>
                        </div>`;
                    }
                    return `<a class="attachment-link" href="${val(a.url)}" target="_blank">
                        <i class="fas fa-file"></i> ${val(a.original_name)}
                    </a>`;
                }).join('');
                attachmentsHtml = `
                    <div class="order-section">
                        <h2><i class="fas fa-paperclip"></i> Attachments / Documents</h2>
                        <div class="attachment-grid">${items}</div>
                    </div>
                `;
            }

            content.innerHTML = metaBar + gesamtbefehl + lage + auftrag + durchfuehrung + versorgung + verbindung + attachmentsHtml;

        } catch (e) {
            content.innerHTML = `<p class="error-msg"><i class="fas fa-exclamation-triangle"></i> Error loading: ${e.message}</p>`;
        }
    }

    document.addEventListener('DOMContentLoaded', () => {
        loadMissionList();
        loadOrder();
    });
</script>

</body>
</html>
