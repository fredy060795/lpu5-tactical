<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Meshtastic Chat & COT - LPU5</title>
    <link rel="manifest" href="/manifest.json">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* =========================
           GLOBAL NAV STYLES
           ========================= */
        :root {
            --sb-collapsed: 70px;
            --sb-expanded: 280px;
            --bg-dark-nav: #121212;
            --border-nav: #282828;
            --accent-nav: #2ecc71;
            --text-dim-nav: #888;
            
            /* Original Meshtastic Vars */
            --bg-dark:#0a0a0a;
            --panel-bg:#1a1a1a;
            --border-color:#333;
            --text-main:#d0d0d0;
            --accent-green:#28a745;
            --accent-red:#dc3545;
        }

        body {
            margin: 0;
            padding-left: var(--sb-collapsed); /* Platz für Sidebar */
            background: #1e1e1e;
            color: #fff;
            font-family: "Courier New", monospace;
            transition: padding-left 0.3s ease;
        }

        .tactical-sidebar {
            width: var(--sb-collapsed);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: var(--bg-dark-nav);
            border-right: 1px solid var(--border-nav);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .tactical-sidebar:hover {
            width: var(--sb-expanded);
        }

        .logo-section {
            padding: 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-nav);
            min-height: 70px;
            box-sizing: border-box;
            text-decoration: none;
            color: inherit;
        }

        .sidebar-logo {
            min-width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .user-meta-info {
            margin-left: 15px;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
        }

        .tactical-sidebar:hover .user-meta-info {
            opacity: 1;
        }

        .user-name { font-weight: bold; font-size: 0.9rem; display: block; }
        .user-status { font-size: 0.75rem; color: var(--accent-nav); }

        .nav-content-sidebar {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: none;
        }

        .nav-content-sidebar::-webkit-scrollbar { display: none; }

        .nav-group {
            border-bottom: 1px solid var(--border-nav);
            padding-bottom: 10px;
        }

        .nav-label {
            padding: 15px 25px 5px;
            font-size: 0.7rem;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tactical-sidebar:hover .nav-label { opacity: 1; }

        .nav-item-sidebar {
            display: flex;
            align-items: center;
            height: 45px;
            color: var(--text-dim-nav);
            text-decoration: none;
            padding: 0 23px;
            transition: 0.2s;
        }

        .nav-item-sidebar i {
            min-width: 24px;
            font-size: 1.1rem;
            text-align: center;
        }

        .nav-text-sidebar {
            margin-left: 20px;
            opacity: 0;
            white-space: nowrap;
            transition: opacity 0.2s;
        }

        .tactical-sidebar:hover .nav-text-sidebar { opacity: 1; }

        .nav-item-sidebar:hover {
            background: #1a1a1a;
            color: #fff;
        }

        .nav-footer { border-top: 1px solid var(--border-nav); }
        .logout-link { color: #e74c3c !important; }

        /* =========================
           PAGE SPECIFIC: Meshtastic Chat
           ========================= */
        .app {
            min-height:100vh;
            display:flex;
            flex-direction:column;
        }

        header.app-header{
            background: linear-gradient(135deg,#1a1a1a 0%, #2d2d2d 100%);
            border-bottom: 1px solid #222;
            padding: 12px 20px;
            display:flex;
            align-items:center;
            gap:12px;
        }
        header.app-header h1{
            color: #ffffff;
            font-size:1.1rem;
            margin:0;
        }

        main.app-main{
            padding:18px;
            display:flex;
            gap:18px;
            align-items:flex-start;
            width:100%;
            box-sizing:border-box;
        }

        .chat-col{
            flex:1 1 720px;
            max-width: 920px;
        }

        .panel {
            background: var(--panel-bg);
            border:1px solid var(--border-color);
            border-radius:8px;
            padding:12px;
        }

        .messages {
            max-height: 74vh;
            overflow:auto;
            padding:12px;
            border-radius:8px;
            background: linear-gradient(#0b0b0b,#0f0f0f);
            border:1px solid #222;
            display:flex;
            flex-direction:column;
            gap:10px;
        }

        .msg-row { display:flex; width:100%; align-items:center; }
        .msg-row.incoming { justify-content:flex-start; }
        .msg-row.outgoing { justify-content:flex-end; }

        .msg-bubble {
            max-width: 78%;
            min-width: 22%;
            padding:12px 14px;
            border-radius:12px;
            background: #0f0f0f;
            border:1px solid #222;
            color:var(--text-main);
            font-size:1rem;
            line-height:1.4;
            box-shadow: 0 1px 0 rgba(255,255,255,0.02) inset;
            word-break:break-word;
        }

        .msg-row.outgoing .msg-bubble { background: #161616; border-color: #2a2a2a; }
        .msg-meta { display:flex; justify-content:space-between; gap:12px; font-size:0.82rem; color:#9a9a9a; margin-bottom:6px; }
        .msg-text { white-space:pre-wrap; color:var(--text-main) }
        .msg-bubble.cot { border-left:4px solid var(--accent-green); }

        .composer { margin-top:14px; display:grid; grid-template-columns: 1fr 260px; gap:12px; align-items:start; }
        .composer-left { display:flex; flex-direction:column; gap:8px; }

        textarea#messageText {
            width:100%; min-height:110px; padding:12px; background:#000; color:#fff;
            border:1px solid #444; border-radius:8px; font-family: 'Courier New', monospace; font-size:1rem;
        }

        .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        select.input, input.input { width:100%; padding:8px; background:#000; color:#fff; border:1px solid #444; border-radius:6px; font-family: 'Courier New', monospace; }

        .side-col{ width:360px; flex:0 0 360px; }
        .section-title { color:#bbb; font-weight:bold; font-size:0.95rem; margin-bottom:8px }
        .history-list { max-height:60vh; overflow:auto; margin-top:8px; border-top:1px dashed #222; padding-top:8px }

        .btn { padding:10px 14px; border-radius:6px; background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border-color); cursor:pointer; font-weight:bold; font-family: 'Courier New', monospace; text-transform:uppercase; }
        .btn-send { background: #071; color:#000; border-color: #063; }
        .btn-cancel { background:#2b2b2b }
        .btn-danger { background: var(--accent-red); color:#fff; border-color:#a71d2a; }
        .btn-danger:hover { background:#c82333; }
        .btn-sm { padding:5px 10px; font-size:0.8rem; }
        .small { font-size:0.85em; color:#999 }

        /* =========================
           Channel Sidebar
           ========================= */
        .chat-layout { display:flex; gap:0; height: calc(100vh - 80px); }

        .channel-sidebar {
            width:260px; min-width:260px; background:#111; border-right:1px solid #222;
            display:flex; flex-direction:column; overflow:hidden;
        }
        .channel-sidebar-header {
            padding:14px 16px; border-bottom:1px solid #222;
            display:flex; align-items:center; justify-content:space-between;
        }
        .channel-sidebar-header h3 { margin:0; font-size:0.95rem; color:#ddd; }
        .channel-sidebar-header button { background:none; border:none; color:var(--accent-green); cursor:pointer; font-size:1.1rem; padding:4px; }
        .channel-sidebar-header button:hover { color:#fff; }

        .channel-list { flex:1; overflow-y:auto; padding:6px 0; }
        .channel-list::-webkit-scrollbar { width:4px; }
        .channel-list::-webkit-scrollbar-thumb { background:#333; border-radius:2px; }

        .channel-item {
            display:flex; align-items:center; padding:10px 16px; cursor:pointer;
            transition: background 0.15s; gap:10px; position:relative;
        }
        .channel-item:hover { background:#1a1a1a; }
        .channel-item.active { background:#1e2a1e; border-left:3px solid var(--accent-green); }
        .channel-item .ch-color {
            width:10px; height:10px; border-radius:50%; flex-shrink:0;
        }
        .channel-item .ch-info { flex:1; min-width:0; }
        .channel-item .ch-name { font-size:0.9rem; color:#ddd; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .channel-item .ch-desc { font-size:0.72rem; color:#666; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
        .channel-item .ch-badge {
            background:var(--accent-green); color:#000; font-size:0.7rem; font-weight:bold;
            padding:1px 6px; border-radius:10px; min-width:14px; text-align:center; display:none;
        }
        .channel-item .ch-actions {
            display:flex; gap:4px; position:absolute; right:8px; top:50%; transform:translateY(-50%);
        }
        .channel-item .ch-actions button {
            background:none; border:none; color:#777; cursor:pointer; font-size:0.8rem; padding:3px;
        }
        .channel-item .ch-actions button:hover { color:#fff; }
        .channel-item .ch-actions .ch-delete:hover { color:var(--accent-red); }

        .chat-main-area { flex:1; display:flex; flex-direction:column; min-width:0; }
        .chat-main-header {
            padding:12px 18px; border-bottom:1px solid #222; background:#0f0f0f;
            display:flex; align-items:center; justify-content:space-between;
        }
        .chat-main-header .ch-title { font-size:1rem; color:#eee; display:flex; align-items:center; gap:8px; }
        .chat-main-header .ch-title .ch-color-dot { width:12px; height:12px; border-radius:50%; }
        .chat-main-header .ch-members { font-size:0.8rem; color:#777; }

        /* =========================
           Modal Styles
           ========================= */
        .modal-overlay {
            display:none; position:fixed; top:0; left:0; width:100%; height:100%;
            background:rgba(0,0,0,0.7); z-index:2000; align-items:center; justify-content:center;
        }
        .modal-overlay.active { display:flex; }
        .modal-box {
            background:#1a1a1a; border:1px solid #333; border-radius:10px;
            padding:24px; width:420px; max-width:90vw; max-height:85vh; overflow-y:auto;
        }
        .modal-box h3 { margin:0 0 16px 0; color:#eee; font-size:1.05rem; }
        .modal-box label { display:block; font-size:0.85rem; color:#aaa; margin-bottom:4px; margin-top:12px; }
        .modal-box input, .modal-box textarea, .modal-box select {
            width:100%; padding:9px 12px; background:#000; color:#fff; border:1px solid #444;
            border-radius:6px; font-family:'Courier New',monospace; font-size:0.9rem; box-sizing:border-box;
        }
        .modal-box textarea { min-height:60px; resize:vertical; }
        .modal-box .color-picker-row { display:flex; gap:8px; margin-top:6px; flex-wrap:wrap; }
        .modal-box .color-swatch {
            width:30px; height:30px; border-radius:50%; cursor:pointer; border:2px solid transparent;
            transition: border-color 0.15s, transform 0.15s;
        }
        .modal-box .color-swatch:hover { transform:scale(1.15); }
        .modal-box .color-swatch.selected { border-color:#fff; transform:scale(1.15); }
        .modal-actions { display:flex; gap:10px; margin-top:20px; justify-content:flex-end; }
        .modal-actions .btn { min-width:100px; text-align:center; }

        /* Members list in modal */
        .members-list { max-height:200px; overflow-y:auto; margin-top:8px; }
        .member-item {
            display:flex; align-items:center; gap:8px; padding:6px 8px; border-bottom:1px solid #222;
        }
        .member-item:last-child { border-bottom:none; }
        .member-item .member-name { flex:1; color:#ccc; font-size:0.85rem; }
        .member-item .member-remove { background:none; border:none; color:#777; cursor:pointer; font-size:0.8rem; }
        .member-item .member-remove:hover { color:var(--accent-red); }

        @media (max-width:1100px){
            main.app-main{ flex-direction:column; padding:0 }
            .chat-layout { flex-direction:column; height:auto; }
            .channel-sidebar { width:100%; min-width:100%; border-right:none; border-bottom:1px solid #222; max-height:200px; }
            .side-col{ width:100%; order:2 }
            .chat-col{ order:1; width:100% }
            .composer { grid-template-columns:1fr; }
        }

        /* Channel Admin Styles */
        .channel-admin-card {
            background: #1e1e1e;
            border: 1px solid #333;
            border-radius: 10px;
            padding: 16px;
            margin-bottom: 14px;
        }
        .channel-admin-card-header {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }
        .channel-admin-color-dot {
            width: 14px;
            height: 14px;
            border-radius: 50%;
            border: 1px solid #555;
            flex-shrink: 0;
        }
        .channel-admin-card-name {
            font-size: 1rem;
            font-weight: bold;
            color: #d0d0d0;
        }
        .channel-admin-card-desc {
            font-size: 0.85rem;
            color: #888;
            margin-left: auto;
        }
        .channel-admin-delete-btn {
            background: none;
            border: 1px solid var(--accent-red);
            color: var(--accent-red);
            cursor: pointer;
            font-size: 0.78rem;
            padding: 3px 10px;
            border-radius: 6px;
            margin-left: 8px;
            flex-shrink: 0;
            transition: background 0.15s, color 0.15s;
        }
        .channel-admin-delete-btn:hover {
            background: var(--accent-red);
            color: #fff;
        }
        .channel-admin-members-list {
            display: flex;
            flex-wrap: wrap;
            gap: 6px;
            margin: 8px 0;
            min-height: 28px;
        }
        .channel-admin-member-tag {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            background: rgba(40,167,69,0.15);
            color: #5ddb7a;
            border: 1px solid rgba(40,167,69,0.3);
            padding: 4px 10px;
            border-radius: 14px;
            font-size: 0.82rem;
        }
        .channel-admin-member-tag .remove-member {
            cursor: pointer;
            margin-left: 2px;
            color: #f55;
            font-size: 0.9rem;
        }
        .channel-admin-member-tag .remove-member:hover {
            color: #ff8888;
        }
        .channel-admin-add-member {
            display: flex;
            gap: 8px;
            align-items: center;
            margin-top: 8px;
        }
        .channel-admin-add-member select {
            flex: 1;
            max-width: 250px;
            background: #111;
            color: #ccc;
            border: 1px solid #444;
            padding: 6px 10px;
            border-radius: 6px;
        }
        .channel-admin-no-members {
            color: #777;
            font-size: 0.85rem;
            font-style: italic;
        }
    </style>
</head>
<body>

<nav class="tactical-sidebar">
    <a href="landing.html" class="logo-section">
        <img src="logo.png" alt="Logo" class="sidebar-logo">
        <div class="user-meta-info">
            <span class="user-name" id="userName">John Doe</span>
            <span class="user-status">Online</span>
        </div>
    </a>

    <div class="nav-content-sidebar">
        <div class="nav-group">
            <div class="nav-label">Dashboard</div>
            <a href="index.html" class="nav-item-sidebar"><i class="fas fa-th-large"></i> <span class="nav-text-sidebar">Dashboard</span></a>
            <a href="mission.html" class="nav-item-sidebar"><i class="fas fa-crosshairs"></i> <span class="nav-text-sidebar">Mission</span></a>
            <a href="statistics.html" class="nav-item-sidebar"><i class="fas fa-chart-bar"></i> <span class="nav-text-sidebar">Statistics</span></a>
        </div>

        <div class="nav-group">
            <div class="nav-label">System</div>
            <a href="admin.html" class="nav-item-sidebar"><i class="fas fa-user-shield"></i> <span class="nav-text-sidebar">Admin</span></a>
            <a href="admin_map.html" class="nav-item-sidebar"><i class="fas fa-map-marked-alt"></i> <span class="nav-text-sidebar">Tactical Map</span></a>
            <a href="overview.html" class="nav-item-sidebar"><i class="fas fa-eye"></i> <span class="nav-text-sidebar">EUD</span></a>
            <a href="stream.html" class="nav-item-sidebar"><i class="fas fa-video"></i> <span class="nav-text-sidebar">Stream</span></a>
            <a href="meshtastic.html" class="nav-item-sidebar"><i class="fas fa-comments"></i> <span class="nav-text-sidebar">Chat</span></a>
            <a href="import_nodes.html" class="nav-item-sidebar"><i class="fas fa-tools"></i> <span class="nav-text-sidebar">Meshtastic Settings</span></a>
            <a href="network.html" class="nav-item-sidebar"><i class="fas fa-network-wired"></i> <span class="nav-text-sidebar">Network</span></a>
            <a href="language.html" class="nav-item-sidebar" title="Language Settings">
                <i class="fas fa-globe"></i> 
                <span class="nav-text-sidebar">Language Settings</span>
            </a>
        </div>
    </div>

    <div class="nav-footer">
        <a href="#" class="nav-item-sidebar logout-link" onclick="logoutUser()">
            <i class="fas fa-power-off"></i> <span class="nav-text-sidebar">Logout</span>
        </a>
    </div>
</nav>

<div class="app">
    <header class="app-header">
        <h1><i class="fas fa-comments"></i> Meshtastic Chat & Channels</h1>
    </header>

    <div class="chat-layout">
        <!-- Channel Sidebar -->
        <aside class="channel-sidebar">
            <div class="channel-sidebar-header">
                <h3><i class="fas fa-hashtag"></i> Channels</h3>
                <button onclick="openChannelAdminModal()" title="Channel-Verwaltung"><i class="fas fa-users-cog"></i></button>
                <button onclick="openCreateChannelModal()" title="Neuen Channel erstellen"><i class="fas fa-plus"></i></button>
            </div>
            <div class="channel-list" id="channelList">
                <div class="small" style="padding:16px;text-align:center">Lade Channels...</div>
            </div>
        </aside>

        <!-- Chat Main Area -->
        <div class="chat-main-area">
            <div class="chat-main-header">
                <div class="ch-title">
                    <span class="ch-color-dot" id="activeChDot" style="background:#fff"></span>
                    <span id="activeChName">Alle Einheiten</span>
                </div>
                <div>
                    <button class="btn btn-sm" onclick="openChannelInfoModal()" title="Channel Info"><i class="fas fa-info-circle"></i></button>
                </div>
            </div>

            <div id="messages" class="messages" aria-live="polite" aria-relevant="additions" style="flex:1;max-height:none;border-radius:0;border:none;border-bottom:1px solid #222">
                <div class="small empty-state">Lade Nachrichten...</div>
            </div>

            <div class="composer" style="padding:12px 16px;margin-top:0">
                <div class="composer-left">
                    <textarea id="messageText" placeholder="Nachricht eingeben..." style="min-height:70px"></textarea>
                    <div class="controls">
                        <select id="messageMode" class="input" aria-label="Message mode" style="max-width:180px">
                            <option value="text">Text</option>
                            <option value="cot">COT (Cursor-On-Target)</option>
                        </select>
                        <button id="sendBtn" class="btn btn-send"><i class="fas fa-paper-plane"></i> Senden</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Hidden select for channel tracking (used by JS) -->
<select id="unitSelect" style="display:none"></select>

<!-- Create Channel Modal -->
<div class="modal-overlay" id="createChannelModal">
    <div class="modal-box">
        <h3><i class="fas fa-plus-circle"></i> Neuen Channel erstellen</h3>
        <label>Channel Name *</label>
        <input id="newChName" type="text" placeholder="z.B. Delta Team" maxlength="50" />
        <label>Beschreibung</label>
        <textarea id="newChDesc" placeholder="Optionale Beschreibung..."></textarea>
        <label>Farbe</label>
        <div class="color-picker-row" id="colorPicker">
            <div class="color-swatch selected" data-color="#ffffff" style="background:#ffffff"></div>
            <div class="color-swatch" data-color="#3498db" style="background:#3498db"></div>
            <div class="color-swatch" data-color="#2ecc71" style="background:#2ecc71"></div>
            <div class="color-swatch" data-color="#e67e22" style="background:#e67e22"></div>
            <div class="color-swatch" data-color="#9b59b6" style="background:#9b59b6"></div>
            <div class="color-swatch" data-color="#e74c3c" style="background:#e74c3c"></div>
            <div class="color-swatch" data-color="#f1c40f" style="background:#f1c40f"></div>
            <div class="color-swatch" data-color="#1abc9c" style="background:#1abc9c"></div>
            <div class="color-swatch" data-color="#e91e63" style="background:#e91e63"></div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeCreateChannelModal()">Abbrechen</button>
            <button class="btn btn-send" onclick="createChannel()"><i class="fas fa-check"></i> Erstellen</button>
        </div>
    </div>
</div>

<!-- Channel Info/Members Modal -->
<div class="modal-overlay" id="channelInfoModal">
    <div class="modal-box">
        <h3><i class="fas fa-info-circle"></i> Channel Info</h3>
        <div id="channelInfoContent">
            <div style="display:flex;align-items:center;gap:10px;margin-bottom:12px">
                <span class="ch-color-dot" id="infoChDot" style="width:16px;height:16px;border-radius:50%"></span>
                <span id="infoChName" style="font-size:1.1rem;color:#eee;font-weight:bold"></span>
            </div>
            <div style="color:#999;font-size:0.85rem;margin-bottom:12px" id="infoChDesc"></div>
            <label>Erstellt von</label>
            <div id="infoChCreator" style="color:#ccc;font-size:0.9rem;margin-bottom:8px">—</div>
            <label>Mitglieder</label>
            <div class="members-list" id="infoMembersList">
                <div class="small">Keine Mitglieder zugewiesen</div>
            </div>
            <div style="margin-top:12px" id="infoChActions"></div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeChannelInfoModal()">Schließen</button>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal-overlay" id="deleteChannelModal">
    <div class="modal-box">
        <h3><i class="fas fa-exclamation-triangle" style="color:var(--accent-red)"></i> Channel löschen</h3>
        <p style="color:#ccc">Möchten Sie den Channel <strong id="deleteChName"></strong> wirklich löschen?</p>
        <p style="color:#999;font-size:0.85rem">Alle Nachrichten in diesem Channel gehen verloren.</p>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeDeleteChannelModal()">Abbrechen</button>
            <button class="btn btn-danger" onclick="confirmDeleteChannel()"><i class="fas fa-trash"></i> Löschen</button>
        </div>
    </div>
</div>

<!-- Channel-Verwaltung Modal -->
<div class="modal-overlay" id="channelAdminModal">
    <div class="modal-box" style="max-width:650px;max-height:80vh;overflow-y:auto">
        <h3><i class="fas fa-users-cog"></i> Channel-Verwaltung</h3>
        <p style="color:#999;font-size:0.9rem;margin-bottom:16px;">Benutzer zu Channels hinzufügen, um Gruppen zu bilden die Nachrichten empfangen können.</p>
        <div id="channelAdminList">
            <div class="small" style="padding:16px;text-align:center">Lade Channels...</div>
        </div>
        <div class="modal-actions">
            <button class="btn btn-cancel" onclick="closeChannelAdminModal()">Schließen</button>
        </div>
    </div>
</div>

<script>
    // ===========================
    // State
    // ===========================
    let channels = [];
    let activeChannelId = 'all';
    let deleteTargetChannelId = null;
    let selectedColor = '#ffffff';
    let gatewayStatusInterval = null;
    let ws = null;

    // ===========================
    // Init
    // ===========================
    document.addEventListener('DOMContentLoaded', () => {
        updateUserNameDisplay();
        initGatewayClient();
        setupWebSocket();
        loadGatewayStatus();
        loadChatChannels();
        setupColorPicker();
        setupEnterToSend();
    });

    function setupEnterToSend() {
        const ta = document.getElementById('messageText');
        if (ta) {
            ta.addEventListener('keydown', (e) => {
                if (e.key === 'Enter' && !e.shiftKey) { e.preventDefault(); sendMessage(); }
            });
        }
    }

    function getAuthHeaders() {
        const token = localStorage.getItem('token') || localStorage.getItem('lpu5_token') || sessionStorage.getItem('token');
        const headers = {};
        if (token) headers['Authorization'] = 'Bearer ' + token;
        return headers;
    }

    // ===========================
    // User Display
    // ===========================
    async function updateUserNameDisplay() {
        const el = document.getElementById('userName');
        if (!el) return;
        let displayName = null;
        try {
            const rawUser = localStorage.getItem('lpu5_user');
            if (rawUser) {
                const userData = JSON.parse(rawUser);
                displayName = userData.name || userData.fullname || userData.username || userData.displayName;
            }
        } catch (e) {}
        if (!displayName) {
            const token = localStorage.getItem('lpu5_token');
            if (token && !token.includes('.') && token.length < 128) displayName = token;
        }
        el.textContent = displayName || 'Guest';
    }

    // ===========================
    // Channel Management
    // ===========================
    async function loadChatChannels() {
        try {
            const resp = await fetch('/api/chat/channels', { headers: getAuthHeaders() });
            if (!resp.ok) return;
            const data = await resp.json();
            if (!data.channels) return;
            channels = data.channels;

            // Populate hidden select (for backward compat)
            const select = document.getElementById('unitSelect');
            if (select) {
                select.innerHTML = '';
                channels.forEach(ch => {
                    const opt = document.createElement('option');
                    opt.value = ch.id;
                    opt.textContent = ch.name || ch.id;
                    select.appendChild(opt);
                });
            }

            renderChannelList();

            // Ensure active channel is still valid
            if (!channels.find(c => c.id === activeChannelId)) {
                activeChannelId = channels.length > 0 ? channels[0].id : 'all';
            }
            setActiveChannel(activeChannelId);
        } catch (e) {
            console.debug('Failed to load chat channels:', e);
        }
    }

    function renderChannelList() {
        const list = document.getElementById('channelList');
        if (!list) return;
        if (channels.length === 0) {
            list.innerHTML = '<div class="small" style="padding:16px;text-align:center">Keine Channels</div>';
            return;
        }
        list.innerHTML = channels.map(ch => {
            const isActive = ch.id === activeChannelId;
            const isDefault = ch.is_default !== false;
            const safeId = escapeAttr(ch.id);
            const safeName = escapeAttr(ch.name);
            const deleteBtn = !isDefault ? `<button class="ch-delete" onclick="event.stopPropagation();openDeleteChannelModal('${safeId}','${safeName}')" title="Löschen"><i class="fas fa-trash-alt"></i></button>` : '';
            return `
            <div class="channel-item${isActive ? ' active' : ''}" onclick="setActiveChannel('${safeId}')" data-channel-id="${safeId}">
                <div class="ch-color" style="background:${escapeAttr(ch.color || '#fff')}"></div>
                <div class="ch-info">
                    <div class="ch-name">${escapeHtml(ch.name || ch.id)}</div>
                    <div class="ch-desc">${escapeHtml(ch.description || '')}</div>
                </div>
                <div class="ch-badge" id="badge-${safeId}"></div>
                <div class="ch-actions">
                    ${deleteBtn}
                </div>
            </div>`;
        }).join('');
    }

    function setActiveChannel(channelId) {
        activeChannelId = channelId;
        const select = document.getElementById('unitSelect');
        if (select) select.value = channelId;

        // Update header
        const ch = channels.find(c => c.id === channelId);
        const dot = document.getElementById('activeChDot');
        const name = document.getElementById('activeChName');
        if (ch) {
            if (dot) dot.style.background = ch.color || '#fff';
            if (name) name.textContent = ch.name || ch.id;
        }

        // Update sidebar active state
        document.querySelectorAll('.channel-item').forEach(el => {
            el.classList.toggle('active', el.dataset.channelId === channelId);
        });

        // Reset badge
        const badge = document.getElementById('badge-' + channelId);
        if (badge) { badge.style.display = 'none'; badge.textContent = ''; }

        loadGatewayMessages();
    }

    // ===========================
    // Create Channel
    // ===========================
    function setupColorPicker() {
        document.querySelectorAll('#colorPicker .color-swatch').forEach(sw => {
            sw.addEventListener('click', () => {
                document.querySelectorAll('#colorPicker .color-swatch').forEach(s => s.classList.remove('selected'));
                sw.classList.add('selected');
                selectedColor = sw.dataset.color;
            });
        });
    }

    function openCreateChannelModal() {
        document.getElementById('newChName').value = '';
        document.getElementById('newChDesc').value = '';
        selectedColor = '#ffffff';
        document.querySelectorAll('#colorPicker .color-swatch').forEach(s => {
            s.classList.toggle('selected', s.dataset.color === '#ffffff');
        });
        document.getElementById('createChannelModal').classList.add('active');
    }
    function closeCreateChannelModal() {
        document.getElementById('createChannelModal').classList.remove('active');
    }

    async function createChannel() {
        const name = document.getElementById('newChName').value.trim();
        if (!name) { alert('Bitte Channel-Name eingeben'); return; }
        const desc = document.getElementById('newChDesc').value.trim();
        try {
            const resp = await fetch('/api/chat/channels', {
                method: 'POST',
                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify({ name, description: desc, color: selectedColor })
            });
            const data = await resp.json();
            if (resp.ok && data.status === 'success') {
                closeCreateChannelModal();
                addLog('success', 'Channel erstellt: ' + name);
                await loadChatChannels();
                if (data.channel) setActiveChannel(data.channel.id);
            } else {
                alert(data.detail || 'Fehler beim Erstellen');
            }
        } catch (e) {
            console.error('Create channel error:', e);
            alert('Fehler: ' + e.message);
        }
    }

    // ===========================
    // Delete Channel
    // ===========================
    function openDeleteChannelModal(channelId, channelName) {
        deleteTargetChannelId = channelId;
        document.getElementById('deleteChName').textContent = channelName;
        document.getElementById('deleteChannelModal').classList.add('active');
    }
    function closeDeleteChannelModal() {
        document.getElementById('deleteChannelModal').classList.remove('active');
        deleteTargetChannelId = null;
    }

    async function confirmDeleteChannel() {
        if (!deleteTargetChannelId) return;
        try {
            const resp = await fetch('/api/chat/channels/' + encodeURIComponent(deleteTargetChannelId), {
                method: 'DELETE',
                headers: getAuthHeaders()
            });
            const data = await resp.json();
            if (resp.ok && data.status === 'success') {
                closeDeleteChannelModal();
                addLog('info', 'Channel gelöscht');
                if (activeChannelId === deleteTargetChannelId) activeChannelId = 'all';
                await loadChatChannels();
            } else {
                alert(data.detail || 'Fehler beim Löschen');
            }
        } catch (e) {
            console.error('Delete channel error:', e);
            alert('Fehler: ' + e.message);
        }
    }

    // ===========================
    // Channel Info Modal
    // ===========================
    function openChannelInfoModal() {
        const ch = channels.find(c => c.id === activeChannelId);
        if (!ch) return;
        document.getElementById('infoChDot').style.background = ch.color || '#fff';
        document.getElementById('infoChName').textContent = ch.name || ch.id;
        document.getElementById('infoChDesc').textContent = ch.description || 'Keine Beschreibung';
        document.getElementById('infoChCreator').textContent = ch.created_by || '—';

        const membersList = document.getElementById('infoMembersList');
        if (ch.members && ch.members.length > 0) {
            membersList.innerHTML = ch.members.map(m => `
                <div class="member-item">
                    <i class="fas fa-user" style="color:#666"></i>
                    <span class="member-name">${escapeHtml(m)}</span>
                </div>`).join('');
        } else {
            membersList.innerHTML = '<div class="small" style="padding:8px">Alle Benutzer (kein Filter)</div>';
        }

        const actions = document.getElementById('infoChActions');
        if (!ch.is_default) {
            actions.innerHTML = `<button class="btn btn-danger btn-sm" onclick="closeChannelInfoModal();openDeleteChannelModal('${escapeAttr(ch.id)}','${escapeAttr(ch.name)}')"><i class="fas fa-trash"></i> Channel löschen</button>`;
        } else {
            actions.innerHTML = '<div class="small">Standard-Channel (kann nicht gelöscht werden)</div>';
        }

        document.getElementById('channelInfoModal').classList.add('active');
    }
    function closeChannelInfoModal() {
        document.getElementById('channelInfoModal').classList.remove('active');
    }

    // ===========================
    // Gateway Client
    // ===========================
    function initGatewayClient() {
        const scanPortsBtn = document.getElementById('scanPortsBtn');
        const connectGatewayBtn = document.getElementById('connectGatewayBtn');
        const disconnectGatewayBtn = document.getElementById('disconnectGatewayBtn');
        if (scanPortsBtn) scanPortsBtn.addEventListener('click', scanPorts);
        if (connectGatewayBtn) connectGatewayBtn.addEventListener('click', connectGateway);
        if (disconnectGatewayBtn) disconnectGatewayBtn.addEventListener('click', disconnectGateway);
        const sendBtn = document.getElementById('sendBtn');
        if (sendBtn) sendBtn.addEventListener('click', sendMessage);
    }

    async function scanPorts() {
        try {
            const select = document.getElementById('comPortSelect');
            if (!select) return;
            const response = await fetch('/api/gateway/ports');
            const data = await response.json();
            select.innerHTML = '<option value="">Port wählen...</option>';
            if (data.ports && data.ports.length > 0) {
                data.ports.forEach(port => {
                    const option = document.createElement('option');
                    option.value = port.device;
                    option.textContent = `${port.device} - ${port.description}`;
                    select.appendChild(option);
                });
                addLog('info', `${data.ports.length} Port(s) gefunden`);
            } else {
                addLog('warning', 'Keine Ports gefunden');
            }
        } catch (error) {
            console.error('Failed to scan ports:', error);
            addLog('error', 'Port-Scan fehlgeschlagen: ' + error.message);
        }
    }

    async function connectGateway() {
        const select = document.getElementById('comPortSelect');
        const port = select ? select.value : '';
        if (!port) { alert('Bitte Port auswählen'); return; }
        addLog('info', `Verbinde mit ${port}...`);
        try {
            const response = await fetch('/api/gateway/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ port: port, auto_sync: true, sync_interval: 300 })
            });
            const data = await response.json();
            if (data.status === 'success' || data.status === 'already_running') {
                addLog('success', `Verbunden mit ${port}`);
                updateConnectionUI(true);
                startStatusPolling();
                loadGatewayMessages();
            } else {
                addLog('error', data.message || 'Verbindung fehlgeschlagen');
                alert(data.message || 'Verbindung fehlgeschlagen');
            }
        } catch (error) {
            console.error('Connection error:', error);
            addLog('error', 'Verbindungsfehler: ' + error.message);
            alert('Verbindung fehlgeschlagen: ' + error.message);
        }
    }

    async function disconnectGateway() {
        addLog('info', 'Trenne Verbindung...');
        try {
            const response = await fetch('/api/gateway/stop', { method: 'POST' });
            const data = await response.json();
            if (data.status === 'success' || data.status === 'not_running') {
                addLog('info', 'Getrennt');
                updateConnectionUI(false);
                stopStatusPolling();
            } else {
                addLog('error', 'Trennen fehlgeschlagen');
            }
        } catch (error) {
            console.error('Disconnect error:', error);
            addLog('error', 'Trennungsfehler: ' + error.message);
        }
    }

    function updateConnectionUI(connected) {
        const statusText = document.getElementById('gatewayStatusText');
        const stats = document.getElementById('gatewayStats');
        const connectBtn = document.getElementById('connectGatewayBtn');
        const disconnectBtn = document.getElementById('disconnectGatewayBtn');
        if (connected) {
            if (statusText) { statusText.textContent = '✓ Verbunden'; statusText.style.color = '#28a745'; }
            if (stats) stats.style.display = 'block';
            if (connectBtn) connectBtn.style.display = 'none';
            if (disconnectBtn) disconnectBtn.style.display = 'block';
        } else {
            if (statusText) { statusText.textContent = 'Nicht verbunden'; statusText.style.color = '#999'; }
            if (stats) stats.style.display = 'none';
            if (connectBtn) connectBtn.style.display = 'block';
            if (disconnectBtn) disconnectBtn.style.display = 'none';
        }
    }

    async function loadGatewayStatus() {
        try {
            const response = await fetch('/api/gateway/status');
            const data = await response.json();
            if (data.running && data.connected) {
                updateConnectionUI(true);
                updateStatusDisplay(data);
                startStatusPolling();
            } else {
                updateConnectionUI(false);
            }
        } catch (error) {
            console.error('Failed to load status:', error);
        }
    }

    function startStatusPolling() {
        if (gatewayStatusInterval) return;
        gatewayStatusInterval = setInterval(async () => {
            try {
                const response = await fetch('/api/gateway/status');
                const data = await response.json();
                if (data.running && data.connected) {
                    updateStatusDisplay(data);
                } else {
                    updateConnectionUI(false);
                    stopStatusPolling();
                }
            } catch (error) {
                console.error('Status poll error:', error);
            }
        }, 5000);
    }

    function stopStatusPolling() {
        if (gatewayStatusInterval) { clearInterval(gatewayStatusInterval); gatewayStatusInterval = null; }
    }

    function updateStatusDisplay(data) {
        const nodesCount = document.getElementById('gatewayNodesCount');
        const messagesCount = document.getElementById('gatewayMessagesCount');
        const uptime = document.getElementById('gatewayUptime');
        if (nodesCount) nodesCount.textContent = data.nodes_synced || 0;
        if (messagesCount) messagesCount.textContent = data.messages_received || 0;
        if (data.uptime_seconds && uptime) {
            const hours = Math.floor(data.uptime_seconds / 3600);
            const minutes = Math.floor((data.uptime_seconds % 3600) / 60);
            uptime.textContent = `${hours}h ${minutes}m`;
        }
    }

    // ===========================
    // Messages
    // ===========================
    async function loadGatewayMessages() {
        try {
            const channelId = activeChannelId || 'all';
            let messages = [];

            // Load from unified chat API
            try {
                const chatResp = await fetch('/api/chat/messages/' + encodeURIComponent(channelId), { headers: getAuthHeaders() });
                if (chatResp.ok) {
                    const chatData = await chatResp.json();
                    if (chatData.messages) messages = chatData.messages;
                }
            } catch (e) { console.debug('Chat API not available:', e); }

            // Also load gateway messages and merge
            try {
                const gwResp = await fetch('/api/gateway/messages?limit=50');
                if (gwResp.ok) {
                    const gwData = await gwResp.json();
                    if (gwData.messages) {
                        gwData.messages.forEach(msg => {
                            messages.push({
                                id: msg.id || '',
                                username: msg.sender_name || msg.from || 'Mesh',
                                text: msg.text || '',
                                timestamp: msg.timestamp || new Date().toISOString(),
                                type: msg.type || 'mesh',
                                delivered_to: [],
                                read_by: []
                            });
                        });
                    }
                }
            } catch (e) { console.debug('Gateway API not available:', e); }

            const messagesEl = document.getElementById('messages');
            const selfName = sessionStorage.getItem('currentUser') || localStorage.getItem('username') || '';

            if (messages.length > 0) {
                messagesEl.innerHTML = messages.map(msg => {
                    const isOutgoing = msg.username === selfName;
                    const rowClass = isOutgoing ? 'outgoing' : 'incoming';
                    const readStatus = _renderReadStatus(msg, isOutgoing);
                    return `
                    <div class="msg-row ${rowClass}" data-msg-id="${msg.id || ''}">
                        <div class="msg-bubble${msg.type === 'cot' ? ' cot' : ''}">
                            <div class="msg-meta">
                                <span>${escapeHtml(msg.username || msg.from || 'Unknown')}</span>
                                <span>${msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : ''}</span>
                            </div>
                            <div class="msg-text">${escapeHtml(msg.text || '')}</div>
                            ${readStatus}
                        </div>
                    </div>`;
                }).join('');
                messagesEl.scrollTop = messagesEl.scrollHeight;

                // Mark incoming messages as delivered
                const token = localStorage.getItem('token') || sessionStorage.getItem('token');
                if (token) {
                    const incomingIds = messages.filter(m => m.id && m.username !== selfName).map(m => m.id);
                    if (incomingIds.length > 0) {
                        fetch('/api/chat/messages/mark-read', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
                            body: JSON.stringify({ message_ids: incomingIds })
                        }).catch(() => {});
                    }
                }
            } else {
                messagesEl.innerHTML = '<div class="small empty-state" style="padding:40px;text-align:center"><i class="fas fa-comments" style="font-size:2rem;display:block;margin-bottom:10px;color:#333"></i>Keine Nachrichten in diesem Channel</div>';
            }
        } catch (error) {
            console.error('Failed to load messages:', error);
        }
    }

    function _renderReadStatus(msg, isOutgoing) {
        if (!isOutgoing) return '';
        let icon = '&#9711;'; // pending
        let color = '#888';
        if (msg.read_by && msg.read_by.length > 0) {
            icon = '&#10003;&#10003;'; color = '#4fc3f7'; // read = blue double check
        } else if (msg.delivered_to && msg.delivered_to.length > 0) {
            icon = '&#10003;&#10003;'; color = '#888'; // delivered = grey double check
        } else if (msg.id) {
            icon = '&#10003;'; // sent = single check
        }
        return '<div class="chat-msg-status" style="text-align:right;font-size:0.7em;color:' + color + ';">' + icon + '</div>';
    }

    async function sendMessage() {
        const text = document.getElementById('messageText').value.trim();
        if (!text) { alert('Bitte Nachricht eingeben'); return; }

        const channelId = activeChannelId || 'all';
        const messageMode = document.getElementById('messageMode') ? document.getElementById('messageMode').value : 'text';
        const selfName = sessionStorage.getItem('currentUser') || localStorage.getItem('username') || 'You';

        // Add to messages display immediately
        const messagesEl = document.getElementById('messages');
        const emptyState = messagesEl.querySelector('.empty-state');
        if (emptyState) emptyState.remove();

        const msgHtml = `
            <div class="msg-row outgoing" data-pending="true">
                <div class="msg-bubble${messageMode === 'cot' ? ' cot' : ''}">
                    <div class="msg-meta">
                        <span>${escapeHtml(selfName)}</span>
                        <span>${new Date().toLocaleTimeString()}</span>
                    </div>
                    <div class="msg-text">${escapeHtml(text)}</div>
                    <div class="chat-msg-status" style="text-align:right;font-size:0.7em;color:#888;">&#9711;</div>
                </div>
            </div>`;
        messagesEl.insertAdjacentHTML('beforeend', msgHtml);
        messagesEl.scrollTop = messagesEl.scrollHeight;
        const pendingEl = messagesEl.querySelector('.msg-row[data-pending="true"]:last-child');

        document.getElementById('messageText').value = '';

        try {
            const resp = await fetch('/api/chat/message', {
                method: 'POST',
                headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
                body: JSON.stringify({ channel_id: channelId, text: text, type: messageMode })
            });
            const data = await resp.json();
            if (data.status === 'success' && data.message) {
                addLog('success', 'Nachricht gesendet: ' + text.substring(0, 30));
                if (pendingEl) {
                    pendingEl.setAttribute('data-msg-id', data.message.id);
                    pendingEl.removeAttribute('data-pending');
                    const st = pendingEl.querySelector('.chat-msg-status');
                    if (st) st.innerHTML = '&#10003;';
                }
            } else {
                addLog('error', 'Senden fehlgeschlagen');
                if (pendingEl) {
                    const st = pendingEl.querySelector('.chat-msg-status');
                    if (st) { st.innerHTML = '&#10007;'; st.style.color = '#f44'; }
                }
            }

            // Also try gateway/meshtastic send (best-effort for mesh relay)
            try {
                await fetch('/api/gateway/send-message', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ text: text })
                });
            } catch (gwErr) {
                console.debug('Gateway relay not available:', gwErr);
            }
        } catch (error) {
            console.error('Send error:', error);
            addLog('error', 'Sendefehler: ' + error.message);
            if (pendingEl) {
                const st = pendingEl.querySelector('.chat-msg-status');
                if (st) { st.innerHTML = '&#10007;'; st.style.color = '#f44'; }
            }
        }
    }

    function addLog(type, message) {
        const time = new Date().toLocaleTimeString();
        console.log(`[${time}] [${type}] ${message}`);
    }

    // ===========================
    // WebSocket for Live Updates
    // ===========================
    function setupWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws`;
        try {
            ws = new WebSocket(wsUrl);
            ws.onopen = () => { console.log('WebSocket connected'); addLog('info', 'WebSocket verbunden'); };
            ws.onmessage = (event) => {
                try { handleWebSocketMessage(JSON.parse(event.data)); }
                catch (error) { console.error('WebSocket message error:', error); }
            };
            ws.onerror = (error) => { console.error('WebSocket error:', error); };
            ws.onclose = () => {
                console.log('WebSocket closed, reconnecting...');
                setTimeout(setupWebSocket, 5000);
            };
        } catch (error) {
            console.error('WebSocket setup error:', error);
            setTimeout(setupWebSocket, 5000);
        }
    }

    function handleWebSocketMessage(data) {
        switch (data.type) {
            case 'gateway_status':
                addLog('info', `Gateway ${data.status}: ${data.port || ''}`);
                if (data.status === 'started') loadGatewayStatus();
                else if (data.status === 'stopped') { updateConnectionUI(false); stopStatusPolling(); }
                break;

            case 'gateway_message':
                if (data.direction === 'incoming' && data.text) {
                    const preview = data.text.substring(0, 30);
                    addLog('info', `📨 Nachricht: ${preview}${data.text.length > 30 ? '...' : ''}`);
                    loadGatewayMessages();
                }
                break;

            case 'gateway_node_update':
                addLog('info', `📡 Node Update: ${data.name || data.id}`);
                break;

            case 'gateway_log':
                addLog(data.level || 'info', data.message);
                break;

            case 'chat_message':
            case 'new_message':
                if (data.data) {
                    const msg = data.data;
                    const selfName = sessionStorage.getItem('currentUser') || localStorage.getItem('username') || '';
                    // If it's our own message, update the pending indicator
                    if (msg.username === selfName) {
                        const pending = document.querySelector('.msg-row[data-pending="true"]');
                        if (pending) {
                            pending.setAttribute('data-msg-id', msg.id);
                            pending.removeAttribute('data-pending');
                            const st = pending.querySelector('.chat-msg-status');
                            if (st) st.innerHTML = '&#10003;';
                        }
                        break;
                    }
                    // If the message belongs to the active channel, show it
                    const msgChannel = msg.channel_id || 'all';
                    if (msgChannel === activeChannelId || activeChannelId === 'all') {
                        const messagesEl = document.getElementById('messages');
                        const emptyState = messagesEl.querySelector('.empty-state');
                        if (emptyState) emptyState.remove();
                        const html = `
                        <div class="msg-row incoming" data-msg-id="${msg.id || ''}">
                            <div class="msg-bubble${msg.type === 'cot' ? ' cot' : ''}">
                                <div class="msg-meta">
                                    <span>${escapeHtml(msg.username || 'Unknown')}</span>
                                    <span>${msg.timestamp ? new Date(msg.timestamp).toLocaleTimeString() : new Date().toLocaleTimeString()}</span>
                                </div>
                                <div class="msg-text">${escapeHtml(msg.text || '')}</div>
                            </div>
                        </div>`;
                        messagesEl.insertAdjacentHTML('beforeend', html);
                        messagesEl.scrollTop = messagesEl.scrollHeight;
                        // Mark as delivered
                        if (msg.id) {
                            const tk = localStorage.getItem('token') || sessionStorage.getItem('token');
                            if (tk) fetch('/api/chat/message/' + msg.id + '/delivered', { method: 'POST', headers: { 'Authorization': 'Bearer ' + tk } }).catch(() => {});
                        }
                    } else {
                        // Show badge on the channel
                        const badge = document.getElementById('badge-' + msgChannel);
                        if (badge) {
                            const count = parseInt(badge.textContent || '0') + 1;
                            badge.textContent = count;
                            badge.style.display = 'block';
                        }
                    }
                }
                break;

            case 'message_status':
                if (data.data) {
                    const d = data.data;
                    if (d.message_id) {
                        const el = document.querySelector('.msg-row[data-msg-id="' + d.message_id + '"] .chat-msg-status');
                        if (el) {
                            if (d.read_by && d.read_by.length > 0) { el.innerHTML = '&#10003;&#10003;'; el.style.color = '#4fc3f7'; }
                            else if (d.delivered_to && d.delivered_to.length > 0) { el.innerHTML = '&#10003;&#10003;'; }
                        }
                    }
                }
                break;

            case 'channel_created':
                addLog('info', 'Neuer Channel erstellt');
                loadChatChannels();
                break;

            case 'channel_deleted':
                addLog('info', 'Channel gelöscht');
                if (data.data && data.data.id === activeChannelId) {
                    activeChannelId = 'all';
                }
                loadChatChannels();
                break;
        }
    }

    // ===========================
    // Channel-Verwaltung (Admin)
    // ===========================
    let _channelAdminAllUsers = [];

    function openChannelAdminModal() {
        document.getElementById('channelAdminModal').classList.add('active');
        loadChannelAdmin();
    }
    function closeChannelAdminModal() {
        document.getElementById('channelAdminModal').classList.remove('active');
    }

    async function loadChannelAdmin() {
      try {
        const [chRes, usRes] = await Promise.all([
          fetch('/api/chat/channels', { headers: getAuthHeaders() }),
          fetch('/api/users', { headers: getAuthHeaders() })
        ]);
        const chData = chRes.ok ? await chRes.json() : {};
        const chList = (chData && chData.channels) ? chData.channels : [];
        _channelAdminAllUsers = usRes.ok ? await usRes.json() : [];
        if (!Array.isArray(_channelAdminAllUsers)) _channelAdminAllUsers = [];

        const container = document.getElementById('channelAdminList');
        if (!container) return;

        if (chList.length === 0) {
          container.innerHTML = '<div class="small" style="padding:16px;text-align:center">Keine Channels vorhanden.</div>';
          return;
        }

        container.innerHTML = chList.map(ch => {
          const members = Array.isArray(ch.members) ? ch.members : [];
          const memberTags = members.length > 0
            ? members.map(m => '<span class="channel-admin-member-tag">' + escapeHtml(m) + ' <span class="remove-member" onclick="removeChannelAdminMember(\'' + escapeAttr(ch.id) + '\',\'' + escapeAttr(m) + '\')" title="Entfernen">&times;</span></span>').join('')
            : '<span class="channel-admin-no-members">Keine Mitglieder</span>';
          const userOptions = _channelAdminAllUsers
            .filter(u => !members.includes(u.username))
            .map(u => '<option value="' + escapeAttr(u.username) + '">' + escapeHtml(u.username || u.id) + '</option>')
            .join('');
          const deleteAdminBtn = !ch.is_default
            ? '<button class="channel-admin-delete-btn" onclick="closeChannelAdminModal();openDeleteChannelModal(\'' + escapeAttr(ch.id) + '\',\'' + escapeAttr(ch.name || ch.id) + '\')" title="Channel löschen"><i class="fas fa-trash-alt"></i> Löschen</button>'
            : '';
          return '<div class="channel-admin-card">' +
            '<div class="channel-admin-card-header">' +
              '<div class="channel-admin-color-dot" style="background:' + escapeAttr(ch.color || '#ffffff') + '"></div>' +
              '<span class="channel-admin-card-name">' + escapeHtml(ch.name || ch.id) + '</span>' +
              '<span class="channel-admin-card-desc">' + escapeHtml(ch.description || '') + '</span>' +
              deleteAdminBtn +
            '</div>' +
            '<div style="font-size:0.85rem;color:#aaa;margin-bottom:4px;">Mitglieder:</div>' +
            '<div class="channel-admin-members-list">' + memberTags + '</div>' +
            '<div class="channel-admin-add-member">' +
              '<select id="addAdminMemberSelect-' + escapeAttr(ch.id) + '">' +
                '<option value="">— Benutzer wählen —</option>' +
                userOptions +
              '</select>' +
              '<button class="btn btn-sm" onclick="addChannelAdminMember(\'' + escapeAttr(ch.id) + '\')"><i class="fas fa-user-plus"></i> Hinzufügen</button>' +
            '</div>' +
          '</div>';
        }).join('');
      } catch (e) {
        console.error('loadChannelAdmin error:', e);
        const container = document.getElementById('channelAdminList');
        if (container) container.innerHTML = '<div class="small" style="padding:16px;text-align:center;color:#f55;">Fehler beim Laden der Channels</div>';
      }
    }

    async function addChannelAdminMember(channelId) {
      const select = document.getElementById('addAdminMemberSelect-' + channelId);
      if (!select || !select.value) { alert('Bitte einen Benutzer auswählen.'); return; }
      const username = select.value;
      try {
        const chRes = await fetch('/api/chat/channels', { headers: getAuthHeaders() });
        const chData = chRes.ok ? await chRes.json() : {};
        const chList = (chData && chData.channels) ? chData.channels : [];
        const ch = chList.find(c => c.id === channelId);
        if (!ch) { alert('Channel nicht gefunden.'); return; }
        const members = Array.isArray(ch.members) ? [...ch.members] : [];
        if (members.includes(username)) { alert('Benutzer ist bereits Mitglied.'); return; }
        members.push(username);
        const res = await fetch('/api/chat/channels/' + encodeURIComponent(channelId) + '/members', {
          method: 'PUT',
          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ members: members })
        });
        if (res.ok) {
          await loadChannelAdmin();
        } else {
          const err = await res.json().catch(() => ({}));
          alert('Fehler: ' + (err.detail || 'Unbekannter Fehler'));
        }
      } catch (e) {
        console.error('addChannelAdminMember error:', e);
        alert('Fehler: ' + e.message);
      }
    }

    async function removeChannelAdminMember(channelId, username) {
      if (!confirm('Benutzer "' + username + '" aus dem Channel entfernen?')) return;
      try {
        const chRes = await fetch('/api/chat/channels', { headers: getAuthHeaders() });
        const chData = chRes.ok ? await chRes.json() : {};
        const chList = (chData && chData.channels) ? chData.channels : [];
        const ch = chList.find(c => c.id === channelId);
        if (!ch) { alert('Channel nicht gefunden.'); return; }
        const members = Array.isArray(ch.members) ? ch.members.filter(m => m !== username) : [];
        const res = await fetch('/api/chat/channels/' + encodeURIComponent(channelId) + '/members', {
          method: 'PUT',
          headers: { ...getAuthHeaders(), 'Content-Type': 'application/json' },
          body: JSON.stringify({ members: members })
        });
        if (res.ok) {
          await loadChannelAdmin();
        } else {
          const err = await res.json().catch(() => ({}));
          alert('Fehler: ' + (err.detail || 'Unbekannter Fehler'));
        }
      } catch (e) {
        console.error('removeChannelAdminMember error:', e);
        alert('Fehler: ' + e.message);
      }
    }

    // ===========================
    // Utilities
    // ===========================
    function escapeHtml(str) {
        const div = document.createElement('div');
        div.textContent = str;
        return div.innerHTML;
    }
    function escapeAttr(str) {
        return String(str).replace(/&/g, '&amp;').replace(/'/g, '&#39;').replace(/"/g, '&quot;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function logoutUser() {
        localStorage.removeItem('token');
        localStorage.removeItem('lpu5_token');
        localStorage.removeItem('lpu5_user');
        sessionStorage.clear();
        window.location.href = 'landing.html';
    }
</script>

</body>
</html>
