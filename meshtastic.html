<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Meshtastic Chat & COT - LPU5</title>
    <link rel="manifest" href="/manifest.json">

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">

    <style>
        /* =========================
           GLOBAL NAV STYLES
           ========================= */
        :root {
            --sb-collapsed: 70px;
            --sb-expanded: 280px;
            --bg-dark-nav: #121212;
            --border-nav: #282828;
            --accent-nav: #2ecc71;
            --text-dim-nav: #888;
            
            /* Original Meshtastic Vars */
            --bg-dark:#0a0a0a;
            --panel-bg:#1a1a1a;
            --border-color:#333;
            --text-main:#d0d0d0;
            --accent-green:#28a745;
            --accent-red:#dc3545;
        }

        body {
            margin: 0;
            padding-left: var(--sb-collapsed); /* Platz f√ºr Sidebar */
            background: #1e1e1e;
            color: #fff;
            font-family: "Courier New", monospace;
            transition: padding-left 0.3s ease;
        }

        .tactical-sidebar {
            width: var(--sb-collapsed);
            height: 100vh;
            position: fixed;
            left: 0;
            top: 0;
            background: var(--bg-dark-nav);
            border-right: 1px solid var(--border-nav);
            transition: width 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            overflow: hidden;
            display: flex;
            flex-direction: column;
            z-index: 1000;
        }

        .tactical-sidebar:hover {
            width: var(--sb-expanded);
        }

        .logo-section {
            padding: 15px;
            display: flex;
            align-items: center;
            border-bottom: 1px solid var(--border-nav);
            min-height: 70px;
            box-sizing: border-box;
            text-decoration: none;
            color: inherit;
        }

        .sidebar-logo {
            min-width: 40px;
            height: 40px;
            object-fit: contain;
        }

        .user-meta-info {
            margin-left: 15px;
            opacity: 0;
            transition: opacity 0.2s;
            white-space: nowrap;
        }

        .tactical-sidebar:hover .user-meta-info {
            opacity: 1;
        }

        .user-name { font-weight: bold; font-size: 0.9rem; display: block; }
        .user-status { font-size: 0.75rem; color: var(--accent-nav); }

        .nav-content-sidebar {
            flex-grow: 1;
            overflow-y: auto;
            overflow-x: hidden;
            scrollbar-width: none;
        }

        .nav-content-sidebar::-webkit-scrollbar { display: none; }

        .nav-group {
            border-bottom: 1px solid var(--border-nav);
            padding-bottom: 10px;
        }

        .nav-label {
            padding: 15px 25px 5px;
            font-size: 0.7rem;
            color: #555;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .tactical-sidebar:hover .nav-label { opacity: 1; }

        .nav-item-sidebar {
            display: flex;
            align-items: center;
            height: 45px;
            color: var(--text-dim-nav);
            text-decoration: none;
            padding: 0 23px;
            transition: 0.2s;
        }

        .nav-item-sidebar i {
            min-width: 24px;
            font-size: 1.1rem;
            text-align: center;
        }

        .nav-text-sidebar {
            margin-left: 20px;
            opacity: 0;
            white-space: nowrap;
            transition: opacity 0.2s;
        }

        .tactical-sidebar:hover .nav-text-sidebar { opacity: 1; }

        .nav-item-sidebar:hover {
            background: #1a1a1a;
            color: #fff;
        }

        .nav-footer { border-top: 1px solid var(--border-nav); }
        .logout-link { color: #e74c3c !important; }

        /* =========================
           PAGE SPECIFIC: Meshtastic Chat
           ========================= */
        .app {
            min-height:100vh;
            display:flex;
            flex-direction:column;
        }

        header.app-header{
            background: linear-gradient(135deg,#1a1a1a 0%, #2d2d2d 100%);
            border-bottom: 1px solid #222;
            padding: 12px 20px;
            display:flex;
            align-items:center;
            gap:12px;
        }
        header.app-header h1{
            color: #ffffff;
            font-size:1.1rem;
            margin:0;
        }

        main.app-main{
            padding:18px;
            display:flex;
            gap:18px;
            align-items:flex-start;
            width:100%;
            box-sizing:border-box;
        }

        .chat-col{
            flex:1 1 720px;
            max-width: 920px;
        }

        .panel {
            background: var(--panel-bg);
            border:1px solid var(--border-color);
            border-radius:8px;
            padding:12px;
        }

        .messages {
            max-height: 74vh;
            overflow:auto;
            padding:12px;
            border-radius:8px;
            background: linear-gradient(#0b0b0b,#0f0f0f);
            border:1px solid #222;
            display:flex;
            flex-direction:column;
            gap:10px;
        }

        .msg-row { display:flex; width:100%; align-items:center; }
        .msg-row.incoming { justify-content:flex-start; }
        .msg-row.outgoing { justify-content:flex-end; }

        .msg-bubble {
            max-width: 78%;
            min-width: 22%;
            padding:12px 14px;
            border-radius:12px;
            background: #0f0f0f;
            border:1px solid #222;
            color:var(--text-main);
            font-size:1rem;
            line-height:1.4;
            box-shadow: 0 1px 0 rgba(255,255,255,0.02) inset;
            word-break:break-word;
        }

        .msg-row.outgoing .msg-bubble { background: #161616; border-color: #2a2a2a; }
        .msg-meta { display:flex; justify-content:space-between; gap:12px; font-size:0.82rem; color:#9a9a9a; margin-bottom:6px; }
        .msg-text { white-space:pre-wrap; color:var(--text-main) }
        .msg-bubble.cot { border-left:4px solid var(--accent-green); }

        .composer { margin-top:14px; display:grid; grid-template-columns: 1fr 260px; gap:12px; align-items:start; }
        .composer-left { display:flex; flex-direction:column; gap:8px; }

        textarea#messageText {
            width:100%; min-height:110px; padding:12px; background:#000; color:#fff;
            border:1px solid #444; border-radius:8px; font-family: 'Courier New', monospace; font-size:1rem;
        }

        .controls { display:flex; gap:8px; align-items:center; flex-wrap:wrap; }
        select.input, input.input { width:100%; padding:8px; background:#000; color:#fff; border:1px solid #444; border-radius:6px; font-family: 'Courier New', monospace; }

        .side-col{ width:360px; flex:0 0 360px; }
        .section-title { color:#bbb; font-weight:bold; font-size:0.95rem; margin-bottom:8px }
        .history-list { max-height:60vh; overflow:auto; margin-top:8px; border-top:1px dashed #222; padding-top:8px }

        .btn { padding:10px 14px; border-radius:6px; background:var(--panel-bg); color:var(--text-main); border:1px solid var(--border-color); cursor:pointer; font-weight:bold; font-family: 'Courier New', monospace; text-transform:uppercase; }
        .btn-send { background: #071; color:#000; border-color: #063; }
        .btn-cancel { background:#2b2b2b }
        .small { font-size:0.85em; color:#999 }

        @media (max-width:1100px){
            main.app-main{ flex-direction:column; padding:12px }
            .side-col{ width:100%; order:2 }
            .chat-col{ order:1; width:100% }
            .composer { grid-template-columns:1fr; }
        }
    </style>
</head>
<body>

<nav class="tactical-sidebar">
    <a href="landing.html" class="logo-section">
        <img src="logo.png" alt="Logo" class="sidebar-logo">
        <div class="user-meta-info">
            <span class="user-name" id="userName">John Doe</span>
            <span class="user-status">Online</span>
        </div>
    </a>

    <div class="nav-content-sidebar">
        <div class="nav-group">
            <div class="nav-label">Dashboard</div>
            <a href="index.html" class="nav-item-sidebar"><i class="fas fa-th-large"></i> <span class="nav-text-sidebar">Dashboard</span></a>
            <a href="mission.html" class="nav-item-sidebar"><i class="fas fa-crosshairs"></i> <span class="nav-text-sidebar">Mission</span></a>
            <a href="statistics.html" class="nav-item-sidebar"><i class="fas fa-chart-bar"></i> <span class="nav-text-sidebar">Statistics</span></a>
        </div>

        <div class="nav-group">
            <div class="nav-label">System</div>
            <a href="admin.html" class="nav-item-sidebar"><i class="fas fa-user-shield"></i> <span class="nav-text-sidebar">Admin</span></a>
            <a href="admin_map.html" class="nav-item-sidebar"><i class="fas fa-map-marked-alt"></i> <span class="nav-text-sidebar">Tactical Map</span></a>
            <a href="overview.html" class="nav-item-sidebar"><i class="fas fa-eye"></i> <span class="nav-text-sidebar">EUD</span></a>
            <a href="stream.html" class="nav-item-sidebar"><i class="fas fa-video"></i> <span class="nav-text-sidebar">Stream</span></a>
            <a href="meshtastic.html" class="nav-item-sidebar"><i class="fas fa-comments"></i> <span class="nav-text-sidebar">Chat</span></a>
            <a href="import_nodes.html" class="nav-item-sidebar"><i class="fas fa-tools"></i> <span class="nav-text-sidebar">Meshtastic Settings</span></a>
            <a href="network.html" class="nav-item-sidebar"><i class="fas fa-network-wired"></i> <span class="nav-text-sidebar">Network</span></a>
            <a href="language.html" class="nav-item-sidebar" title="Language Settings">
                <i class="fas fa-globe"></i> 
                <span class="nav-text-sidebar">Language Settings</span>
            </a>
        </div>
    </div>

    <div class="nav-footer">
        <a href="#" class="nav-item-sidebar logout-link" onclick="logoutUser()">
            <i class="fas fa-power-off"></i> <span class="nav-text-sidebar">Logout</span>
        </a>
    </div>
</nav>

<div class="app">
    <header class="app-header">
        <h1>Meshtastic Chat - COT Integration</h1>
    </header>

    <main class="app-main" role="main">
        <section class="chat-col">
            <div class="panel">
                <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                    <div class="section-title">Chat Window</div>
                    <div class="small">Bridge: USB (import_nodes) ‚Ä¢ CoT: supported</div>
                </div>

                <div id="messages" class="messages" aria-live="polite" aria-relevant="additions">
                    <div class="small empty-state">Loading messages...</div>
                </div>

                <div class="composer">
                    <div class="composer-left">
                        <label class="small">Message</label>
                        <textarea id="messageText" placeholder="Enter your message..."></textarea>

                        <div class="controls">
                            <select id="unitSelect" class="input" aria-label="Sending unit">
                                <option value="">Choose sender unit...</option>
                            </select>

                            <select id="messageMode" class="input" aria-label="Message mode">
                                <option value="text">Text</option>
                                <option value="cot">COT (Cursor-On-Target)</option>
                            </select>

                            <button id="sendBtn" class="btn btn-send"><i class="fas fa-paper-plane"></i> Send</button>
                        </div>
                    </div>

                    <aside class="right-panel">
                        <div class="section-title">Message Parameters</div>
                        <div class="panel" style="margin-bottom:10px">
                            <div class="setting-row">
                                <label>Frequency (MHz)</label>
                                <input id="frequency" class="input" type="number" step="0.01" min="0" placeholder="e.g. 433.50" />
                            </div>
                            <div id="cotSettings" style="display:none; margin-top:6px">
                                <div class="small" style="margin-bottom:6px">COT Settings</div>
                                <div class="setting-row">
                                    <label>Type</label>
                                    <select id="cotType" class="input">
                                        <option value="a-f-G-U-C">a-f-G-U-C</option>
                                        <option value="b-m-p">b-m-p</option>
                                    </select>
                                </div>
                                <div class="setting-row">
                                    <label>Coords.</label>
                                    <input id="cotLat" class="input" type="number" step="0.000001" placeholder="Lat" />
                                    <input id="cotLon" class="input" type="number" step="0.000001" placeholder="Lon" />
                                </div>
                            </div>
                        </div>
                        <div class="section-title">Send History</div>
                        <div id="sendHistory" class="history-list panel">
                            <div class="small">No sent messages</div>
                        </div>
                    </aside>
                </div>
            </div>
        </section>

        <aside class="side-col">
            <!-- Gateway Connection Panel -->
            <div class="panel">
                <div class="section-title">üîó Gateway Connection</div>
                <div class="setting-row">
                    <select id="comPortSelect" class="input">
                        <option value="">Select port...</option>
                    </select>
                </div>
                <button id="scanPortsBtn" class="btn" style="width:100%; margin-top:5px;"><i class="fas fa-search"></i> Scan Ports</button>
                <div style="display:flex; gap:5px; margin-top:5px;">
                    <button id="connectGatewayBtn" class="btn btn-send" style="flex:1;"><i class="fas fa-plug"></i> Connect</button>
                    <button id="disconnectGatewayBtn" class="btn btn-cancel" style="flex:1; display:none;"><i class="fas fa-times"></i> Disconnect</button>
                </div>
                <div id="gatewayStatus" class="small" style="margin-top:8px; padding:8px; background:#0f0f0f; border-radius:4px;">
                    <div><strong>Status:</strong> <span id="gatewayStatusText">Not connected</span></div>
                    <div id="gatewayStats" style="display:none; margin-top:4px;">
                        <div><strong>Nodes:</strong> <span id="gatewayNodesCount">0</span></div>
                        <div><strong>Messages:</strong> <span id="gatewayMessagesCount">0</span></div>
                        <div><strong>Uptime:</strong> <span id="gatewayUptime">-</span></div>
                    </div>
                </div>
            </div>

            <!-- Gateway Nodes Panel -->
            <div class="panel" style="margin-top:12px">
                <div class="section-title">üì° Gateway Nodes</div>
                <button id="refreshNodesBtn" class="btn" style="width:100%; margin-bottom:5px;"><i class="fas fa-sync"></i> Refresh</button>
                <div id="gatewayNodesList" class="history-list" style="max-height:30vh;">
                    <div class="small">No nodes imported</div>
                </div>
            </div>

            <!-- Gateway Log Panel -->
            <div class="panel" style="margin-top:12px">
                <div class="section-title">üìã Gateway Log</div>
                <button id="clearLogBtn" class="btn" style="width:100%; margin-bottom:5px;"><i class="fas fa-trash"></i> Clear Log</button>
                <div id="gatewayLog" class="history-list" style="max-height:20vh; font-size:0.8rem;">
                    <div class="small">Gateway not started</div>
                </div>
            </div>
        </aside>
    </main>
</div>

<script>
    // ===========================
    // User Display
    // ===========================
    document.addEventListener('DOMContentLoaded', () => {
        updateUserNameDisplay();
        initGatewayClient();
        setupWebSocket();
        loadGatewayStatus();
    });

    async function updateUserNameDisplay() {
        const el = document.getElementById('userName');
        if (!el) return;
        let displayName = null;
        try {
            const rawUser = localStorage.getItem('lpu5_user');
            if (rawUser) {
                const userData = JSON.parse(rawUser);
                displayName = userData.name || userData.fullname || userData.username || userData.displayName;
            }
        } catch (e) {}
        if (!displayName) {
            const token = localStorage.getItem('lpu5_token');
            if (token && !token.includes('.') && token.length < 128) displayName = token;
        }
        el.textContent = displayName || 'Guest';
    }

    // ===========================
    // Gateway Client
    // ===========================
    let gatewayStatusInterval = null;
    let ws = null;

    function initGatewayClient() {
        // Event listeners
        document.getElementById('scanPortsBtn').addEventListener('click', scanPorts);
        document.getElementById('connectGatewayBtn').addEventListener('click', connectGateway);
        document.getElementById('disconnectGatewayBtn').addEventListener('click', disconnectGateway);
        document.getElementById('refreshNodesBtn').addEventListener('click', loadGatewayNodes);
        document.getElementById('clearLogBtn').addEventListener('click', clearLog);
        document.getElementById('sendBtn').addEventListener('click', sendMessage);
        
        // Load initial data
        scanPorts();
    }

    async function scanPorts() {
        try {
            const response = await fetch('/api/gateway/ports');
            const data = await response.json();
            
            const select = document.getElementById('comPortSelect');
            select.innerHTML = '<option value="">Select port...</option>';
            
            if (data.ports && data.ports.length > 0) {
                data.ports.forEach(port => {
                    const option = document.createElement('option');
                    option.value = port.device;
                    option.textContent = `${port.device} - ${port.description}`;
                    select.appendChild(option);
                });
                addLog('info', `Found ${data.ports.length} port(s)`);
            } else {
                addLog('warning', 'No ports found');
            }
        } catch (error) {
            console.error('Failed to scan ports:', error);
            addLog('error', 'Failed to scan ports: ' + error.message);
        }
    }

    async function connectGateway() {
        const port = document.getElementById('comPortSelect').value;
        if (!port) {
            alert('Please select a port');
            return;
        }

        addLog('info', `Connecting to ${port}...`);
        
        try {
            const response = await fetch('/api/gateway/start', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    port: port,
                    auto_sync: true,
                    sync_interval: 300
                })
            });
            
            const data = await response.json();
            
            if (data.status === 'success' || data.status === 'already_running') {
                addLog('success', `Connected to ${port}`);
                updateConnectionUI(true);
                startStatusPolling();
                loadGatewayNodes();
                loadGatewayMessages();
            } else {
                addLog('error', data.message || 'Connection failed');
                alert(data.message || 'Failed to connect');
            }
        } catch (error) {
            console.error('Connection error:', error);
            addLog('error', 'Connection error: ' + error.message);
            alert('Failed to connect: ' + error.message);
        }
    }

    async function disconnectGateway() {
        addLog('info', 'Disconnecting...');
        
        try {
            const response = await fetch('/api/gateway/stop', {
                method: 'POST'
            });
            
            const data = await response.json();
            
            if (data.status === 'success' || data.status === 'not_running') {
                addLog('info', 'Disconnected');
                updateConnectionUI(false);
                stopStatusPolling();
            } else {
                addLog('error', 'Disconnect failed');
            }
        } catch (error) {
            console.error('Disconnect error:', error);
            addLog('error', 'Disconnect error: ' + error.message);
        }
    }

    function updateConnectionUI(connected) {
        const statusText = document.getElementById('gatewayStatusText');
        const stats = document.getElementById('gatewayStats');
        const connectBtn = document.getElementById('connectGatewayBtn');
        const disconnectBtn = document.getElementById('disconnectGatewayBtn');
        
        if (connected) {
            statusText.textContent = '‚úì Connected';
            statusText.style.color = '#28a745';
            stats.style.display = 'block';
            connectBtn.style.display = 'none';
            disconnectBtn.style.display = 'block';
        } else {
            statusText.textContent = 'Not connected';
            statusText.style.color = '#999';
            stats.style.display = 'none';
            connectBtn.style.display = 'block';
            disconnectBtn.style.display = 'none';
        }
    }

    async function loadGatewayStatus() {
        try {
            const response = await fetch('/api/gateway/status');
            const data = await response.json();
            
            if (data.running && data.connected) {
                updateConnectionUI(true);
                updateStatusDisplay(data);
                startStatusPolling();
            } else {
                updateConnectionUI(false);
            }
        } catch (error) {
            console.error('Failed to load status:', error);
        }
    }

    function startStatusPolling() {
        if (gatewayStatusInterval) return;
        
        gatewayStatusInterval = setInterval(async () => {
            try {
                const response = await fetch('/api/gateway/status');
                const data = await response.json();
                
                if (data.running && data.connected) {
                    updateStatusDisplay(data);
                } else {
                    updateConnectionUI(false);
                    stopStatusPolling();
                }
            } catch (error) {
                console.error('Status poll error:', error);
            }
        }, 5000);
    }

    function stopStatusPolling() {
        if (gatewayStatusInterval) {
            clearInterval(gatewayStatusInterval);
            gatewayStatusInterval = null;
        }
    }

    function updateStatusDisplay(data) {
        document.getElementById('gatewayNodesCount').textContent = data.nodes_synced || 0;
        document.getElementById('gatewayMessagesCount').textContent = data.messages_received || 0;
        
        if (data.uptime_seconds) {
            const hours = Math.floor(data.uptime_seconds / 3600);
            const minutes = Math.floor((data.uptime_seconds % 3600) / 60);
            document.getElementById('gatewayUptime').textContent = `${hours}h ${minutes}m`;
        }
    }

    async function loadGatewayNodes() {
        try {
            const response = await fetch('/api/gateway/nodes');
            const data = await response.json();
            
            const listEl = document.getElementById('gatewayNodesList');
            
            if (data.nodes && data.nodes.length > 0) {
                listEl.innerHTML = data.nodes.map(node => `
                    <div class="small" style="padding:6px; margin-bottom:4px; background:#0f0f0f; border-radius:4px; border-left:3px solid ${node.has_gps ? '#28a745' : '#666'};">
                        <div style="font-weight:bold; color:#ddd;">${node.name || node.id}</div>
                        <div style="color:#999; font-size:0.85em;">
                            ${node.has_gps && node.lat != null && node.lng != null ? `üìç ${node.lat.toFixed(5)}, ${node.lng.toFixed(5)}` : 'üìç No GPS'}
                        </div>
                        <div style="color:#888; font-size:0.8em;">
                            ${node.hardware || 'Unknown'} | ${node.battery ? node.battery + '%' : 'No battery'}
                        </div>
                    </div>
                `).join('');
            } else {
                listEl.innerHTML = '<div class="small">No nodes imported</div>';
            }
        } catch (error) {
            console.error('Failed to load nodes:', error);
            addLog('error', 'Failed to load nodes: ' + error.message);
        }
    }

    async function loadGatewayMessages() {
        try {
            const response = await fetch('/api/gateway/messages?limit=50');
            const data = await response.json();
            
            const messagesEl = document.getElementById('messages');
            
            if (data.messages && data.messages.length > 0) {
                messagesEl.innerHTML = data.messages.map(msg => `
                    <div class="msg-row incoming">
                        <div class="msg-bubble">
                            <div class="msg-meta">
                                <span>${msg.sender_name || msg.from}</span>
                                <span>${new Date(msg.timestamp).toLocaleTimeString()}</span>
                            </div>
                            <div class="msg-text">${msg.text}</div>
                        </div>
                    </div>
                `).join('');
                
                // Scroll to bottom
                messagesEl.scrollTop = messagesEl.scrollHeight;
            } else {
                messagesEl.innerHTML = '<div class="small empty-state">No messages yet</div>';
            }
        } catch (error) {
            console.error('Failed to load messages:', error);
        }
    }

    async function sendMessage() {
        const text = document.getElementById('messageText').value.trim();
        if (!text) {
            alert('Please enter a message');
            return;
        }

        try {
            const response = await fetch('/api/gateway/send-message', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ text: text })
            });
            
            const data = await response.json();
            
            if (data.status === 'success') {
                addLog('success', 'Message sent: ' + text.substring(0, 30));
                document.getElementById('messageText').value = '';
                
                // Add to messages display
                const messagesEl = document.getElementById('messages');
                const msgHtml = `
                    <div class="msg-row outgoing">
                        <div class="msg-bubble">
                            <div class="msg-meta">
                                <span>You</span>
                                <span>${new Date().toLocaleTimeString()}</span>
                            </div>
                            <div class="msg-text">${text}</div>
                        </div>
                    </div>
                `;
                messagesEl.insertAdjacentHTML('beforeend', msgHtml);
                messagesEl.scrollTop = messagesEl.scrollHeight;
            } else {
                addLog('error', 'Failed to send message');
                alert('Failed to send message: ' + (data.message || 'Unknown error'));
            }
        } catch (error) {
            console.error('Send error:', error);
            addLog('error', 'Send error: ' + error.message);
            alert('Failed to send message: ' + error.message);
        }
    }

    function addLog(type, message) {
        const logEl = document.getElementById('gatewayLog');
        const time = new Date().toLocaleTimeString();
        
        const colors = {
            info: '#5bc0de',
            success: '#28a745',
            warning: '#ffc107',
            error: '#dc3545'
        };
        
        const icon = {
            info: '‚ÑπÔ∏è',
            success: '‚úì',
            warning: '‚ö†Ô∏è',
            error: '‚úó'
        };
        
        const entry = document.createElement('div');
        entry.style.padding = '4px';
        entry.style.borderBottom = '1px solid #222';
        entry.style.color = colors[type] || '#999';
        entry.innerHTML = `<span style="color:#666;">[${time}]</span> ${icon[type] || ''} ${message}`;
        
        // Remove placeholder
        if (logEl.querySelector('.small')) {
            logEl.innerHTML = '';
        }
        
        logEl.appendChild(entry);
        
        // Keep only last 50 entries
        while (logEl.children.length > 50) {
            logEl.removeChild(logEl.firstChild);
        }
        
        // Auto-scroll
        logEl.scrollTop = logEl.scrollHeight;
    }

    function clearLog() {
        const logEl = document.getElementById('gatewayLog');
        logEl.innerHTML = '<div class="small">Log cleared</div>';
    }

    // ===========================
    // WebSocket for Live Updates
    // ===========================
    function setupWebSocket() {
        const protocol = window.location.protocol === 'https:' ? 'wss:' : 'ws:';
        const wsUrl = `${protocol}//${window.location.host}/ws`;
        
        try {
            ws = new WebSocket(wsUrl);
            
            ws.onopen = () => {
                console.log('WebSocket connected');
                addLog('info', 'WebSocket connected');
            };
            
            ws.onmessage = (event) => {
                try {
                    const data = JSON.parse(event.data);
                    handleWebSocketMessage(data);
                } catch (error) {
                    console.error('WebSocket message error:', error);
                }
            };
            
            ws.onerror = (error) => {
                console.error('WebSocket error:', error);
                addLog('warning', 'WebSocket connection issue');
            };
            
            ws.onclose = () => {
                console.log('WebSocket closed, reconnecting...');
                addLog('warning', 'WebSocket disconnected, reconnecting...');
                setTimeout(setupWebSocket, 5000);
            };
        } catch (error) {
            console.error('WebSocket setup error:', error);
            setTimeout(setupWebSocket, 5000);
        }
    }

    function handleWebSocketMessage(data) {
        switch (data.type) {
            case 'gateway_status':
                addLog('info', `Gateway ${data.status}: ${data.port || ''}`);
                if (data.status === 'started') {
                    loadGatewayStatus();
                    loadGatewayNodes();
                } else if (data.status === 'stopped') {
                    updateConnectionUI(false);
                    stopStatusPolling();
                }
                break;
                
            case 'gateway_message':
                if (data.direction === 'incoming' && data.text) {
                    const preview = data.text.substring(0, 30);
                    addLog('info', `üì® Message: ${preview}${data.text.length > 30 ? '...' : ''}`);
                    loadGatewayMessages();
                }
                break;
                
            case 'gateway_node_update':
                addLog('info', `üì° Node update: ${data.name || data.id}`);
                loadGatewayNodes();
                break;
                
            case 'gateway_log':
                addLog(data.level || 'info', data.message);
                break;
        }
    }
</script>

</body>
</html>
