<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Settings - LPU5 Tactical</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --sb-collapsed: 70px;
            --sb-expanded: 280px;
            --bg-dark: #121212;
            --panel-bg: #1a1a1a;
            --border: #282828;
            --border-color: #333;
            --accent: #2ecc71;
            --accent-blue: #3498db;
            --accent-yellow: #f39c12;
            --accent-red: #e74c3c;
            --text-main: #d0d0d0;
            --text-dim: #888;
            --muted: #666;
        }

        body {
            margin: 0;
            padding-left: var(--sb-collapsed);
            background: #0a0a0a;
            color: var(--text-main);
            font-family: 'Courier New', monospace;
            transition: padding-left 0.3s ease;
        }

        .page-container {
            padding: 20px;
            max-width: 1400px;
            margin: 0 auto;
        }

        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            padding-bottom: 15px;
            border-bottom: 2px solid var(--border);
        }

        .page-title {
            font-size: 1.8rem;
            font-weight: bold;
            color: var(--text-main);
        }

        .page-title i {
            color: var(--accent-blue);
            margin-right: 10px;
        }

        .section {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 4px;
        }

        .section-header {
            font-size: 1.2rem;
            font-weight: bold;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--border);
            color: var(--text-main);
        }

        .section-header i {
            color: var(--accent-blue);
            margin-right: 8px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            font-size: 0.85rem;
            color: var(--text-dim);
            margin-bottom: 5px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .form-input,
        .form-select {
            width: 100%;
            padding: 10px;
            background: #0a0a0a;
            border: 1px solid var(--border-color);
            color: var(--text-main);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            border-radius: 3px;
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--accent-blue);
        }

        .form-checkbox {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 10px;
        }

        .form-checkbox input[type="checkbox"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
        }

        .form-checkbox label {
            color: var(--text-main);
            font-size: 0.9rem;
            cursor: pointer;
        }

        .btn {
            padding: 10px 20px;
            border: 1px solid var(--border-color);
            background: #2d2d2d;
            color: var(--text-main);
            font-family: 'Courier New', monospace;
            font-size: 0.9rem;
            cursor: pointer;
            border-radius: 3px;
            transition: all 0.2s;
        }

        .btn:hover {
            background: #3d3d3d;
            border-color: var(--accent-blue);
        }

        .btn-primary {
            background: var(--accent-blue);
            border-color: var(--accent-blue);
            color: white;
        }

        .btn-primary:hover {
            background: #2980b9;
        }

        .btn-success {
            background: var(--accent);
            border-color: var(--accent);
            color: white;
        }

        .btn-success:hover {
            background: #27ae60;
        }

        .btn-danger {
            background: var(--accent-red);
            border-color: var(--accent-red);
            color: white;
        }

        .btn-danger:hover {
            background: #c0392b;
        }

        .info-box {
            padding: 12px;
            background: rgba(52, 152, 219, 0.1);
            border: 1px solid rgba(52, 152, 219, 0.3);
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: var(--text-main);
        }

        .info-box i {
            color: var(--accent-blue);
            margin-right: 8px;
        }

        .warning-box {
            padding: 12px;
            background: rgba(243, 156, 18, 0.1);
            border: 1px solid rgba(243, 156, 18, 0.3);
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: var(--text-main);
        }

        .warning-box i {
            color: var(--accent-yellow);
            margin-right: 8px;
        }

        .success-box {
            padding: 12px;
            background: rgba(46, 204, 113, 0.1);
            border: 1px solid rgba(46, 204, 113, 0.3);
            border-radius: 4px;
            margin-bottom: 15px;
            font-size: 0.85rem;
            color: var(--text-main);
        }

        .success-box i {
            color: var(--accent);
            margin-right: 8px;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .status-active {
            background: var(--accent);
            box-shadow: 0 0 8px var(--accent);
        }

        .status-inactive {
            background: var(--muted);
        }

        .network-info-item {
            display: flex;
            justify-content: space-between;
            padding: 10px;
            border-bottom: 1px solid var(--border);
            font-size: 0.9rem;
        }

        .network-info-label {
            color: var(--text-dim);
        }

        .network-info-value {
            color: var(--text-main);
            font-weight: bold;
        }

        .button-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        @media (max-width: 768px) {
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .page-container {
                padding: 10px 8px;
            }
            .section {
                padding: 12px;
            }
            .form-input,
            .form-select,
            .btn {
                min-height: 44px;
            }
        }
    </style>
</head>
<body>

<!-- Global Navigation -->
<script src="load-global-nav.js"></script>

<div class="page-container">
    <div class="page-header">
        <div class="page-title">
            <i class="fas fa-network-wired"></i>
            Network Settings
        </div>
    </div>

    <!-- Network Status Section -->
    <div class="section">
        <div class="section-header">
            <i class="fas fa-signal"></i>
            Network Status
        </div>
        <div id="networkStatus">
            <div class="network-info-item">
                <span class="network-info-label">Server Status:</span>
                <span class="network-info-value">
                    <span class="status-indicator status-active"></span>
                    Online
                </span>
            </div>
            <div class="network-info-item">
                <span class="network-info-label">Local IP Address:</span>
                <span class="network-info-value" id="localIpDisplay">Loading...</span>
            </div>
            <div class="network-info-item">
                <span class="network-info-label">Port:</span>
                <span class="network-info-value" id="portDisplay">8101</span>
            </div>
            <div class="network-info-item">
                <span class="network-info-label">Server URL:</span>
                <span class="network-info-value" id="serverUrlDisplay">Loading...</span>
            </div>
        </div>
    </div>

    <div class="grid-2">
        <!-- Server Forwarding Section -->
        <div class="section">
            <div class="section-header">
                <i class="fas fa-exchange-alt"></i>
                Server Forwarding
            </div>
            
            <div class="info-box">
                <i class="fas fa-info-circle"></i>
                Configure forwarding of actions to external servers (e.g. for backup or central management).
            </div>

            <div class="form-group">
                <div class="form-checkbox">
                    <input type="checkbox" id="enableForwarding">
                    <label for="enableForwarding">Enable server forwarding</label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Target Server URL</label>
                <input type="text" class="form-input" id="forwardingUrl" placeholder="https://example.com:8101" disabled>
            </div>

            <div class="form-group">
                <label class="form-label">Events to Forward</label>
                <div class="form-checkbox">
                    <input type="checkbox" id="forwardRegistrations" disabled>
                    <label for="forwardRegistrations">User Registrations</label>
                </div>
                <div class="form-checkbox">
                    <input type="checkbox" id="forwardQRCodes" disabled>
                    <label for="forwardQRCodes">QR Code Creation</label>
                </div>
                <div class="form-checkbox">
                    <input type="checkbox" id="forwardMarkers" disabled>
                    <label for="forwardMarkers">Map Marker Updates</label>
                </div>
                <div class="form-checkbox">
                    <input type="checkbox" id="forwardMissions" disabled>
                    <label for="forwardMissions">Mission Updates</label>
                </div>
            </div>
        </div>

        <!-- Public IP Configuration Section -->
        <div class="section">
            <div class="section-header">
                <i class="fas fa-globe"></i>
                Public IP Configuration
            </div>
            
            <div class="info-box">
                <i class="fas fa-info-circle"></i>
                Configure public IP address for external access (e.g. for QR codes).
            </div>

            <div class="form-group">
                <div class="form-checkbox">
                    <input type="checkbox" id="usePublicIp">
                    <label for="usePublicIp">Use public IP for QR codes</label>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Public IP/Domain</label>
                <input type="text" class="form-input" id="publicIp" placeholder="e.g. 203.0.113.1 or domain.example.com" disabled>
            </div>

            <div class="form-group">
                <label class="form-label">Public Port</label>
                <input type="number" class="form-input" id="publicPort" placeholder="8101" disabled>
            </div>

            <div class="warning-box">
                <i class="fas fa-exclamation-triangle"></i>
                Ensure port forwarding is configured in your router.
            </div>
        </div>
    </div>

    <!-- Network Security Section -->
    <div class="section">
        <div class="section-header">
            <i class="fas fa-shield-alt"></i>
            Network Security
        </div>

        <div class="grid-2">
            <div>
                <div class="form-group">
                    <label class="form-label">Allowed IP Ranges (CIDR)</label>
                    <input type="text" class="form-input" id="allowedIpRanges" placeholder="e.g. 192.168.1.0/24">
                </div>
                
                <div class="info-box">
                    <i class="fas fa-info-circle"></i>
                    Restrict access to specific IP ranges. Separate multiple ranges with commas.
                </div>
            </div>

            <div>
                <div class="form-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="requireAuth">
                        <label for="requireAuth">Authentication required</label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="enableRateLimiting">
                        <label for="enableRateLimiting">Enable rate limiting</label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="logNetworkAccess">
                        <label for="logNetworkAccess">Log network access</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- TAK Server Integration Section -->
    <div class="section">
        <div class="section-header">
            <i class="fas fa-satellite-dish"></i>
            TAK Server Integration
        </div>

        <div class="info-box">
            <i class="fas fa-info-circle"></i>
            Connect this server to a TAK Server for advanced tactical operations (similar to ATAK/WINTAK).
        </div>

        <div class="info-box" style="background:#fff8e1;border-left:4px solid #f59e0b;color:#1a1a1a;">
            <i class="fas fa-lightbulb" style="color:#b8860b;"></i>
            <strong>WinTAK / ATAK on the same machine?</strong>
            Use <strong>Connection Type: TCP</strong>, Host: <code>127.0.0.1</code>, Port: <code>8087</code> — no certificate required.
            SSL (port 8089) requires a client certificate; use TCP for local connections to avoid this.
        </div>

        <div class="grid-2">
            <div>
                <div class="form-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="enableTakIntegration">
                        <label for="enableTakIntegration">Enable TAK Server integration</label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">TAK Server Host/IP</label>
                    <input type="text" class="form-input" id="takServerUrl" placeholder="192.168.1.100 or takserver.example.com" disabled
                        oninput="this.value=_cleanTakHost(this.value)">
                </div>

                <div class="form-group">
                    <label class="form-label">Connection Type</label>
                    <select class="form-select" id="takConnectionType" disabled onchange="_onTakConnectionTypeChange(this.value)">
                        <option value="tcp">TCP</option>
                        <option value="udp">UDP</option>
                        <option value="ssl">SSL/TLS</option>
                    </select>
                </div>
            </div>

            <div>
                <div class="form-group">
                    <label class="form-label">TAK Server Port</label>
                    <input type="number" class="form-input" id="takServerPort" placeholder="8087" disabled>
                </div>

                
                <div class="form-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="takAutoReconnect" disabled>
                        <label for="takAutoReconnect">Reconnect automatically</label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">TAK Server Username</label>
                    <input type="text" class="form-input" id="takUsername" placeholder="Username" autocomplete="username" disabled>
                </div>

                <div class="form-group">
                    <label class="form-label">TAK Server Password</label>
                    <input type="password" class="form-input" id="takPassword" placeholder="Password" autocomplete="current-password" disabled>
                </div>

                <div class="form-group">
                    <label class="form-label">Client Certificate Path (mTLS)</label>
                    <input type="text" class="form-input" id="takClientCertPath" placeholder="/path/to/client.pem (required when server demands a certificate)" disabled>
                </div>

                <div class="form-group">
                    <label class="form-label">Client Key Path (mTLS)</label>
                    <input type="text" class="form-input" id="takClientKeyPath" placeholder="/path/to/client.key" disabled>
                </div>

                <div class="form-group">
                    <button class="btn" id="takTestBtn" onclick="testTakConnection()" disabled>
                        <i class="fas fa-plug"></i> Test TAK Connection
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- CoT Listener Section -->
    <div class="section">
        <div class="section-header">
            <i class="fas fa-satellite-dish"></i>
            CoT Listener (Inbound ATAK Data)
        </div>

        <div class="info-box">
            <i class="fas fa-info-circle"></i>
            The CoT listener opens local TCP and UDP sockets so that ATAK clients can
            send CoT XML directly to this server. Received events are stored as map
            markers and broadcast to all connected clients in real time.
            The listener starts automatically on server startup.
            <br><br>
            <strong>SA Multicast (239.2.3.1:6969 UDP)</strong> enables bidirectional CoT exchange with WinTAK/ATAK
            using the standard Situational Awareness multicast group. When enabled, LPU5 joins the multicast group
            to receive position updates <em>and</em> sends marker updates back to all TAK clients on the same LAN
            — no dedicated TAK server required.
        </div>

        <div class="info-box" style="background:#e8f5e9;border-left:4px solid #4caf50;color:#1a1a1a;">
            <i class="fas fa-mobile-alt" style="color:#2e7d32;"></i>
            <strong>WinTAK / ATAK on the same Windows machine — recommended setup:</strong>
            <ol style="margin:6px 0 0 18px;padding:0;">
                <li>Enable <strong>SA Multicast</strong> below and set group <code>239.2.3.1</code>, port <code>6969</code>.</li>
                <li>In WinTAK open <em>Settings → Network → Multicast</em> and ensure SA Multicast is active on <code>239.2.3.1:6969 UDP</code>.</li>
                <li>LPU5 will automatically receive WinTAK position updates and push marker changes back via the same multicast group.</li>
            </ol>
            <strong>Alternative — TCP direct connect (bidirectional):</strong> In WinTAK/ATAK open <em>Settings → Network → Server Connections</em>,
            set <strong>Address</strong> to <code id="cotListenerHostHint">127.0.0.1</code> and <strong>Port</strong> to <code>8088</code> (TCP, no SSL).
            For ATAK on a different device, replace <code>127.0.0.1</code> with this server's IP shown at the top of this page.<br>
            <em>When connected via TCP, WinTAK/ATAK receives all existing LPU5 markers immediately on connect and all subsequent changes in real time — no TAK server required.</em>
        </div>

        <div class="form-grid">
            <div class="form-group">
                <label class="form-label">TCP Port (ATAK direct connect)</label>
                <input type="number" class="form-input" id="cotListenerTcpPort" value="8088" min="1" max="65535">
            </div>
            <div class="form-group">
                <label class="form-label">UDP Port (legacy unicast)</label>
                <input type="number" class="form-input" id="cotListenerUdpPort" value="4242" min="1" max="65535">
            </div>
        </div>

        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="saMulticastEnabled" checked>
                <label for="saMulticastEnabled"><strong>Enable SA Multicast</strong> — bidirectional CoT exchange with WinTAK/ATAK (recommended when both run on the same machine)</label>
            </div>
        </div>

        <div class="form-grid" id="saMulticastFields">
            <div class="form-group">
                <label class="form-label">SA Multicast Gruppe</label>
                <input type="text" class="form-input" id="saMulticastGroup" value="239.2.3.1" placeholder="239.2.3.1">
            </div>
            <div class="form-group">
                <label class="form-label">SA Multicast Port (UDP)</label>
                <input type="number" class="form-input" id="saMulticastPort" value="6969" min="1" max="65535" placeholder="6969">
            </div>
        </div>

        <div class="form-group">
            <div class="checkbox-group">
                <input type="checkbox" id="cotListenerAutoStart" checked>
                <label for="cotListenerAutoStart">Start listener automatically on server startup</label>
            </div>
        </div>

        <div class="form-group" style="display:flex;gap:8px;flex-wrap:wrap;">
            <button class="btn btn-success" id="cotListenerStartBtn" onclick="startCotListener()">
                <i class="fas fa-play"></i> Start Listener
            </button>
            <button class="btn btn-danger" id="cotListenerStopBtn" onclick="stopCotListener()">
                <i class="fas fa-stop"></i> Stop Listener
            </button>
            <button class="btn" onclick="refreshCotListenerStatus()">
                <i class="fas fa-sync"></i> Refresh Status
            </button>
        </div>

        <div id="cotListenerStatus" class="info-box" style="margin-top:8px;display:none;"></div>
    </div>

    <!-- CoT (Cursor on Target) Settings -->
    <div class="section">
        <div class="section-header">
            <i class="fas fa-crosshairs"></i>
            CoT (Cursor on Target) Settings
        </div>

        <div class="info-box">
            <i class="fas fa-info-circle"></i>
            Configure CoT messages for interoperability with ATAK/WINTAK systems.
        </div>

        <div class="grid-2">
            <div>
                <div class="form-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="enableCoT">
                        <label for="enableCoT">Enable CoT support</label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">CoT Broadcast Interval (seconds)</label>
                    <input type="number" class="form-input" id="cotInterval" placeholder="30" value="30" disabled>
                </div>

                <div class="form-group">
                    <label class="form-label">Default CoT Type</label>
                    <select class="form-select" id="cotType" disabled>
                        <option value="a-f-G">Friendly Unit</option>
                        <option value="a-h-G">Hostile Unit</option>
                        <option value="a-n-G">Neutral Unit</option>
                        <option value="a-u-G">Unknown Unit</option>
                    </select>
                </div>
            </div>

            <div>
                <div class="form-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="cotIncludeCallsign" disabled>
                        <label for="cotIncludeCallsign">Include callsign in CoT</label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="cotIncludeTeam" disabled>
                        <label for="cotIncludeTeam">Include team information</label>
                    </div>
                </div>

                <div class="form-group">
                    <div class="form-checkbox">
                        <input type="checkbox" id="cotIncludeRemarks" disabled>
                        <label for="cotIncludeRemarks">Include remarks</label>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Save Settings -->
    <div class="button-group">
        <button class="btn btn-success" onclick="saveNetworkSettings()">
            <i class="fas fa-save"></i> Save Settings
        </button>
        <button class="btn" onclick="loadNetworkSettings()">
            <i class="fas fa-sync-alt"></i> Reset
        </button>
        <button class="btn" onclick="testConnection()">
            <i class="fas fa-network-wired"></i> Test Connection
        </button>
    </div>

    <div id="saveStatus" style="margin-top: 15px; display: none;"></div>
</div>

<script>
// Retrieve stored auth token from localStorage
function _getAuthToken() {
    const direct = localStorage.getItem('lpu5_token');
    if (direct) return direct;
    try { return JSON.parse(localStorage.getItem('lpu5_user') || '{}').token || null; } catch (_) { return null; }
}

// Strip URL schemes (http:// / https://) and trailing slashes from a host string
function _cleanTakHost(value) {
    return value.replace(/^https?:\/\//, '').replace(/\/+$/, '');
}

// Load server info on page load
async function loadServerInfo() {
    try {
        const response = await fetch('/api/server_info');
        if (response.ok) {
            const data = await response.json();
            document.getElementById('localIpDisplay').textContent = data.local_ip || 'N/A';
            document.getElementById('portDisplay').textContent = data.port || '8101';
            document.getElementById('serverUrlDisplay').textContent = data.base_url || 'N/A';
            // Update CoT listener hint with the server's actual local IP
            const hint = document.getElementById('cotListenerHostHint');
            if (hint && data.local_ip && data.local_ip !== 'N/A') {
                hint.textContent = data.local_ip;
            }
        }
    } catch (error) {
        console.error('Error loading server info:', error);
        document.getElementById('localIpDisplay').textContent = 'Error loading';
        document.getElementById('serverUrlDisplay').textContent = 'Error loading';
    }
}

// Load network settings from server
async function loadNetworkSettings() {
    try {
        const response = await fetch('/api/config');
        if (response.ok) {
            const config = await response.json();
            const networkConfig = config.network || {};

            // Server Forwarding
            document.getElementById('enableForwarding').checked = networkConfig.enableForwarding || false;
            document.getElementById('forwardingUrl').value = networkConfig.forwardingUrl || '';
            document.getElementById('forwardRegistrations').checked = networkConfig.forwardRegistrations || false;
            document.getElementById('forwardQRCodes').checked = networkConfig.forwardQRCodes || false;
            document.getElementById('forwardMarkers').checked = networkConfig.forwardMarkers || false;
            document.getElementById('forwardMissions').checked = networkConfig.forwardMissions || false;

            // Public IP
            document.getElementById('usePublicIp').checked = networkConfig.usePublicIp || false;
            document.getElementById('publicIp').value = networkConfig.publicIp || '';
            document.getElementById('publicPort').value = networkConfig.publicPort || '8101';

            // Security
            document.getElementById('allowedIpRanges').value = networkConfig.allowedIpRanges || '';
            document.getElementById('requireAuth').checked = networkConfig.requireAuth !== false;
            document.getElementById('enableRateLimiting').checked = networkConfig.enableRateLimiting || false;
            document.getElementById('logNetworkAccess').checked = networkConfig.logNetworkAccess !== false;

            // TAK Server – load from authenticated config endpoint (root-level keys) with
            // fallback to the network section for backwards-compatibility
            try {
                const takResp = await fetch('/api/tak/config');
                if (takResp.ok) {
                    const takCfg = await takResp.json();
                    document.getElementById('enableTakIntegration').checked = takCfg.tak_forward_enabled !== undefined ? takCfg.tak_forward_enabled : (networkConfig.enableTakIntegration || false);
                    document.getElementById('takServerUrl').value = takCfg.tak_server_host || networkConfig.takServerUrl || '';
                    document.getElementById('takConnectionType').value = takCfg.tak_connection_type || networkConfig.takConnectionType || 'tcp';
                    document.getElementById('takServerPort').value = takCfg.tak_server_port || networkConfig.takServerPort || '8087';
                    document.getElementById('takUsername').value = takCfg.tak_username || '';
                    document.getElementById('takClientCertPath').value = takCfg.tak_client_cert_path || '';
                    document.getElementById('takClientKeyPath').value = takCfg.tak_client_key_path || '';
                } else {
                    document.getElementById('enableTakIntegration').checked = networkConfig.enableTakIntegration || false;
                    document.getElementById('takServerUrl').value = networkConfig.takServerUrl || '';
                    document.getElementById('takConnectionType').value = networkConfig.takConnectionType || 'tcp';
                    document.getElementById('takServerPort').value = networkConfig.takServerPort || '8087';
                }
            } catch (_e) {
                console.warn('Could not load TAK config:', _e);
                document.getElementById('enableTakIntegration').checked = networkConfig.enableTakIntegration || false;
                document.getElementById('takServerUrl').value = networkConfig.takServerUrl || '';
                document.getElementById('takConnectionType').value = networkConfig.takConnectionType || 'tcp';
                document.getElementById('takServerPort').value = networkConfig.takServerPort || '8087';
            }
            document.getElementById('takAutoReconnect').checked = networkConfig.takAutoReconnect !== false;

            // CoT Settings
            document.getElementById('enableCoT').checked = networkConfig.enableCoT || false;
            document.getElementById('cotInterval').value = networkConfig.cotInterval || '30';
            document.getElementById('cotType').value = networkConfig.cotType || 'a-f-G';
            document.getElementById('cotIncludeCallsign').checked = networkConfig.cotIncludeCallsign !== false;
            document.getElementById('cotIncludeTeam').checked = networkConfig.cotIncludeTeam !== false;
            document.getElementById('cotIncludeRemarks').checked = networkConfig.cotIncludeRemarks || false;

            // CoT Listener ports & auto-start
            try {
                const cfgRaw = await fetch('/api/config');
                if (cfgRaw.ok) {
                    const rawCfg = await cfgRaw.json();
                    document.getElementById('cotListenerTcpPort').value = rawCfg.cot_listener_tcp_port || 8088;
                    document.getElementById('cotListenerUdpPort').value = rawCfg.cot_listener_udp_port || 4242;
                    // Default to true (matches server-side default) – listener auto-starts unless explicitly disabled
                    document.getElementById('cotListenerAutoStart').checked = rawCfg.cot_listener_enabled !== false;
                }
            } catch (_) { /* use defaults */ }

            // SA Multicast settings
            try {
                const takResp2 = await fetch('/api/tak/config');
                if (takResp2.ok) {
                    const takCfg2 = await takResp2.json();
                    document.getElementById('saMulticastEnabled').checked = takCfg2.sa_multicast_enabled || false;
                    document.getElementById('saMulticastGroup').value = takCfg2.sa_multicast_group || '239.2.3.1';
                    document.getElementById('saMulticastPort').value = takCfg2.sa_multicast_port || 6969;
                }
            } catch (_) { /* use defaults */ }
            updateSaMulticastState();

            // Update UI state
            updateForwardingState();
            updatePublicIpState();
            updateTakIntegrationState();
            updateCoTState();
        }
    } catch (error) {
        console.error('Error loading network settings:', error);
        showStatus('Error loading settings', 'error');
    }
}

// Save network settings to server
async function saveNetworkSettings() {
    try {
        const networkConfig = {
            network: {
                // Server Forwarding
                enableForwarding: document.getElementById('enableForwarding').checked,
                forwardingUrl: document.getElementById('forwardingUrl').value,
                forwardRegistrations: document.getElementById('forwardRegistrations').checked,
                forwardQRCodes: document.getElementById('forwardQRCodes').checked,
                forwardMarkers: document.getElementById('forwardMarkers').checked,
                forwardMissions: document.getElementById('forwardMissions').checked,

                // Public IP
                usePublicIp: document.getElementById('usePublicIp').checked,
                publicIp: document.getElementById('publicIp').value,
                publicPort: document.getElementById('publicPort').value,

                // Security
                allowedIpRanges: document.getElementById('allowedIpRanges').value,
                requireAuth: document.getElementById('requireAuth').checked,
                enableRateLimiting: document.getElementById('enableRateLimiting').checked,
                logNetworkAccess: document.getElementById('logNetworkAccess').checked,

                // TAK Server
                enableTakIntegration: document.getElementById('enableTakIntegration').checked,
                takServerUrl: document.getElementById('takServerUrl').value,
                takConnectionType: document.getElementById('takConnectionType').value,
                takServerPort: document.getElementById('takServerPort').value,
                takAutoReconnect: document.getElementById('takAutoReconnect').checked,

                // CoT Settings
                enableCoT: document.getElementById('enableCoT').checked,
                cotInterval: document.getElementById('cotInterval').value,
                cotType: document.getElementById('cotType').value,
                cotIncludeCallsign: document.getElementById('cotIncludeCallsign').checked,
                cotIncludeTeam: document.getElementById('cotIncludeTeam').checked,
                cotIncludeRemarks: document.getElementById('cotIncludeRemarks').checked
            }
        };

        const response = await fetch('/api/config', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(networkConfig)
        });

        if (!response.ok) {
            showStatus('Error saving settings', 'error');
            return;
        }

        // Save TAK credentials and settings via the authenticated endpoint
        const takEnabled = document.getElementById('enableTakIntegration').checked;
        const takBody = {
            tak_forward_enabled: takEnabled,
            tak_server_host: _cleanTakHost(document.getElementById('takServerUrl').value),
            tak_server_port: parseInt(document.getElementById('takServerPort').value, 10) || 8087,
            tak_connection_type: document.getElementById('takConnectionType').value,
            tak_username: document.getElementById('takUsername').value.trim(),
            tak_client_cert_path: document.getElementById('takClientCertPath').value.trim(),
            tak_client_key_path: document.getElementById('takClientKeyPath').value.trim(),
            // CoT Listener settings
            cot_listener_tcp_port: parseInt(document.getElementById('cotListenerTcpPort').value, 10) || 8088,
            cot_listener_udp_port: parseInt(document.getElementById('cotListenerUdpPort').value, 10) || 4242,
            cot_listener_enabled: document.getElementById('cotListenerAutoStart').checked,
            // SA Multicast settings
            sa_multicast_enabled: document.getElementById('saMulticastEnabled').checked,
            sa_multicast_group: document.getElementById('saMulticastGroup').value.trim() || '239.2.3.1',
            sa_multicast_port: parseInt(document.getElementById('saMulticastPort').value, 10) || 6969,
        };
        const takPassword = document.getElementById('takPassword').value;
        if (takPassword) { takBody.tak_password = takPassword; }
        const token = _getAuthToken();
        if (token) {
            const takResp = await fetch('/api/tak/config', {
                method: 'PUT',
                headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` },
                body: JSON.stringify(takBody)
            });
            if (!takResp.ok) {
                const err = await takResp.json().catch(() => ({}));
                showStatus('Settings saved, but TAK config update failed: ' + (err.detail || takResp.status), 'error');
                return;
            }
        } else {
            showStatus('Network settings saved. TAK-specific settings (host/port/credentials) could not be saved - no valid authentication token found. Please log in and save again.', 'error');
            return;
        }

        showStatus('Settings saved successfully', 'success');
    } catch (error) {
        console.error('Error saving network settings:', error);
        showStatus('Error saving settings', 'error');
    }
}

// Test network connection
async function testConnection() {
    showStatus('Testing connection...', 'info');
    try {
        const response = await fetch('/api/health');
        if (response.ok) {
            showStatus('Connection successful!', 'success');
        } else {
            showStatus('Connection failed', 'error');
        }
    } catch (error) {
        console.error('Connection test failed:', error);
        showStatus('Connection failed: ' + error.message, 'error');
    }
}

// Auto-update the port suggestion when the TAK connection type changes.
// Default ports: TCP=8087 (no SSL), UDP=4242, SSL=8089.
function _onTakConnectionTypeChange(type) {
    const portInput = document.getElementById('takServerPort');
    if (!portInput || portInput.disabled) return;
    const currentPort = parseInt(portInput.value, 10);
    const defaultPorts = { tcp: 8087, udp: 4242, ssl: 8089 };
    // Only overwrite when the port is still set to a known TAK default (avoid clobbering custom values).
    const knownDefaults = new Set(Object.values(defaultPorts));
    if (!currentPort || knownDefaults.has(currentPort)) {
        portInput.value = defaultPorts[type] || 8089;
    }
}

// Test TAK server connectivity
async function testTakConnection() {
    showStatus('Testing TAK server connection...', 'info');
    try {
        const response = await fetch('/api/tak/test');
        const result = await response.json();
        if (result.reachable) {
            const exchanged = result.data_exchanged ? ' ✓ Data exchanged.' : '';
            showStatus('TAK: ' + result.message + exchanged, 'success');
        } else {
            showStatus('TAK unreachable: ' + result.message, 'error');
        }
    } catch (error) {
        console.error('TAK connection test failed:', error);
        showStatus('TAK connection test failed: ' + error.message, 'error');
    }
}

function _showCotListenerStatus(result) {
    const div = document.getElementById('cotListenerStatus');
    div.style.display = 'block';
    if (result.running) {
        div.className = 'success-box';
        const mcast = result.multicast_enabled
            ? ` | SA Multicast: ${result.multicast_group || '239.2.3.1'}:${result.multicast_port || 6969} (${result.multicast_datagrams || 0} dgrams)`
            : '';
        const clients = result.tcp_clients_active !== undefined
            ? ` | WinTAK clients: ${result.tcp_clients_active}`
            : '';
        div.innerHTML = `<i class="fas fa-check-circle"></i> Listener running — TCP:${result.tcp_port || '?'} UDP:${result.udp_port || '?'}${mcast}${clients} | events_received: ${result.events_received || 0} | events_ingested: ${result.events_ingested || 0} | uptime: ${result.uptime_seconds || 0}s`;
    } else if (result.available === false) {
        div.className = 'warning-box';
        div.innerHTML = `<i class="fas fa-exclamation-triangle"></i> ${result.message || 'CoT listener not available'}`;
    } else {
        div.className = 'info-box';
        div.innerHTML = `<i class="fas fa-info-circle"></i> ${result.message || 'Listener stopped'}`;
    }
}

async function refreshCotListenerStatus() {
    try {
        const resp = await fetch('/api/cot/listener/status');
        const result = await resp.json();
        _showCotListenerStatus(result);
    } catch (e) {
        console.error('CoT listener status error:', e);
    }
}

async function startCotListener() {
    const token = localStorage.getItem('token') || sessionStorage.getItem('token');
    const tcpPort = parseInt(document.getElementById('cotListenerTcpPort').value) || 8088;
    const udpPort = parseInt(document.getElementById('cotListenerUdpPort').value) || 4242;
    const autoStart = document.getElementById('cotListenerAutoStart').checked;
    const saMulticastEnabled = document.getElementById('saMulticastEnabled').checked;
    const saMulticastGroup = document.getElementById('saMulticastGroup').value.trim() || '239.2.3.1';
    const saMulticastPort = parseInt(document.getElementById('saMulticastPort').value) || 6969;

    // Persist port and multicast config to server config first
    try {
        await fetch('/api/tak/config', {
            method: 'PUT',
            headers: { 'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token },
            body: JSON.stringify({
                cot_listener_tcp_port: tcpPort,
                cot_listener_udp_port: udpPort,
                cot_listener_enabled: autoStart,
                sa_multicast_enabled: saMulticastEnabled,
                sa_multicast_group: saMulticastGroup,
                sa_multicast_port: saMulticastPort,
            })
        });
    } catch (_) { /* ignore config save errors */ }

    try {
        const resp = await fetch('/api/cot/listener/start', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const result = await resp.json();
        _showCotListenerStatus(result);
        showStatus('CoT listener started', 'success');
    } catch (e) {
        showStatus('Failed to start CoT listener: ' + e.message, 'error');
    }
}

async function stopCotListener() {
    const token = localStorage.getItem('token') || sessionStorage.getItem('token');
    try {
        const resp = await fetch('/api/cot/listener/stop', {
            method: 'POST',
            headers: { 'Authorization': 'Bearer ' + token }
        });
        const result = await resp.json();
        _showCotListenerStatus({ running: false, available: true, message: 'Listener stopped.' });
        showStatus('CoT listener stopped', 'success');
    } catch (e) {
        showStatus('Failed to stop CoT listener: ' + e.message, 'error');
    }
}

// Show status message
function showStatus(message, type) {
    const statusDiv = document.getElementById('saveStatus');
    statusDiv.style.display = 'block';
    
    let className = 'info-box';
    let icon = 'fa-info-circle';
    
    if (type === 'success') {
        className = 'success-box';
        icon = 'fa-check-circle';
    } else if (type === 'error') {
        className = 'warning-box';
        icon = 'fa-exclamation-triangle';
    }
    
    statusDiv.className = className;
    statusDiv.innerHTML = `<i class="fas ${icon}"></i>${message}`;
    
    // Auto-hide after 5 seconds
    setTimeout(() => {
        statusDiv.style.display = 'none';
    }, 5000);
}

// Update forwarding state
function updateForwardingState() {
    const enabled = document.getElementById('enableForwarding').checked;
    document.getElementById('forwardingUrl').disabled = !enabled;
    document.getElementById('forwardRegistrations').disabled = !enabled;
    document.getElementById('forwardQRCodes').disabled = !enabled;
    document.getElementById('forwardMarkers').disabled = !enabled;
    document.getElementById('forwardMissions').disabled = !enabled;
}

// Update public IP state
function updatePublicIpState() {
    const enabled = document.getElementById('usePublicIp').checked;
    document.getElementById('publicIp').disabled = !enabled;
    document.getElementById('publicPort').disabled = !enabled;
}

// Update TAK integration state
function updateTakIntegrationState() {
    const enabled = document.getElementById('enableTakIntegration').checked;
    document.getElementById('takServerUrl').disabled = !enabled;
    document.getElementById('takConnectionType').disabled = !enabled;
    document.getElementById('takServerPort').disabled = !enabled;
    document.getElementById('takAutoReconnect').disabled = !enabled;
    document.getElementById('takUsername').disabled = !enabled;
    document.getElementById('takPassword').disabled = !enabled;
    document.getElementById('takClientCertPath').disabled = !enabled;
    document.getElementById('takClientKeyPath').disabled = !enabled;
    document.getElementById('takTestBtn').disabled = !enabled;
}

// Update CoT state
function updateCoTState() {
    const enabled = document.getElementById('enableCoT').checked;
    document.getElementById('cotInterval').disabled = !enabled;
    document.getElementById('cotType').disabled = !enabled;
    document.getElementById('cotIncludeCallsign').disabled = !enabled;
    document.getElementById('cotIncludeTeam').disabled = !enabled;
    document.getElementById('cotIncludeRemarks').disabled = !enabled;
}

function updateSaMulticastState() {
    const enabled = document.getElementById('saMulticastEnabled').checked;
    const fields = document.getElementById('saMulticastFields');
    if (fields) {
        fields.style.opacity = enabled ? '1' : '0.5';
        fields.querySelectorAll('input').forEach(el => { el.disabled = !enabled; });
    }
}

// Event listeners
document.getElementById('enableForwarding').addEventListener('change', updateForwardingState);
document.getElementById('usePublicIp').addEventListener('change', updatePublicIpState);
document.getElementById('enableTakIntegration').addEventListener('change', updateTakIntegrationState);
document.getElementById('enableCoT').addEventListener('change', updateCoTState);
document.getElementById('saMulticastEnabled').addEventListener('change', updateSaMulticastState);

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    loadServerInfo();
    loadNetworkSettings();
    refreshCotListenerStatus();
});
</script>

<script src="assets/sidebar.js"></script>
</body>
</html>
