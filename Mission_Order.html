<!DOCTYPE html>
<html lang="de">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MISSION ORDER</title>
    <link rel="manifest" href="/manifest.json">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        :root {
            --bg-dark: #0a0a0a;
            --panel-bg: #1a1a1a;
            --border-color: #333;
            --text-main: #d0d0d0;
            --accent-blue: #ffffff;
            --accent-green: #28a745;
            --accent-red: #dc3545;
            --tactical-gray: #2d2d2d;
        }

        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            background: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Courier New', monospace;
            overflow-x: hidden;
        }

        header {
            background: linear-gradient(135deg, #1a1a1a 0%, #2d2d2d 100%);
            border-bottom: 2px solid var(--accent-blue);
            padding: 15px 20px;
            display: flex;
            align-items: center;
            gap: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.35);
        }

        h1 {
            color: var(--accent-blue);
            font-size: 1.5em;
            margin: 0;
        }

        .container {
            padding: 20px;
            max-width: 900px;
            margin: 0 auto;
        }

        .order-section {
            background: var(--panel-bg);
            border: 1px solid var(--border-color);
            padding: 20px;
            border-radius: 8px;
            margin-bottom: 18px;
        }

        .order-section h2 {
            color: var(--accent-blue);
            margin-bottom: 14px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.1em;
            text-transform: uppercase;
            border-bottom: 1px solid var(--border-color);
            padding-bottom: 8px;
        }

        .field-row {
            margin-bottom: 12px;
        }

        .field-label {
            color: #888;
            text-transform: uppercase;
            font-size: 0.8em;
            font-weight: bold;
            margin-bottom: 4px;
        }

        .field-value {
            background: #000;
            border: 1px solid #333;
            border-radius: 4px;
            padding: 10px;
            color: #fff;
            min-height: 36px;
            white-space: pre-wrap;
            word-break: break-word;
        }

        .field-value.empty {
            color: #555;
            font-style: italic;
        }

        .status-ONGOING { color: #ffaa00; font-weight: bold; }
        .status-SUCCESS { color: #00ff00; font-weight: bold; }
        .status-FAILED  { color: #ff0000; font-weight: bold; }

        .meta-bar {
            display: flex;
            flex-wrap: wrap;
            gap: 20px;
            margin-bottom: 6px;
            font-size: 0.9em;
            color: #aaa;
        }

        .meta-bar span strong {
            color: var(--text-main);
        }

        .loading-msg, .error-msg {
            text-align: center;
            padding: 40px;
            color: #888;
            font-style: italic;
        }

        .error-msg { color: var(--accent-red); }

        .attachment-grid {
            display: flex;
            flex-wrap: wrap;
            gap: 12px;
            margin-top: 8px;
        }

        .attachment-thumb {
            border: 1px solid #333;
            border-radius: 6px;
            overflow: hidden;
            background: #000;
            max-width: 200px;
            text-align: center;
        }

        .attachment-thumb img {
            width: 100%;
            max-height: 150px;
            object-fit: cover;
            display: block;
        }

        .attachment-label {
            font-size: 0.75em;
            color: #888;
            padding: 4px 6px;
            word-break: break-all;
        }

        .attachment-link {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            background: #111;
            border: 1px solid #333;
            border-radius: 4px;
            color: #aaa;
            text-decoration: none;
            font-size: 0.85em;
        }

        .attachment-link:hover { color: #fff; }

        @media (max-width: 768px) {
            header { padding: 12px 16px; }
            h1 { font-size: 1.1em; }
            .container { padding: 12px; }
        }
    </style>
</head>
<body>

<header>
    <i class="fas fa-scroll" style="font-size:1.4em;"></i>
    <h1>MISSION ORDER &mdash; <span id="headerTitle">...</span></h1>
</header>

<div class="container" id="mainContent">
    <p class="loading-msg"><i class="fas fa-spinner fa-spin"></i> Loading mission order...</p>
</div>

<script>
    function getMissionId() {
        const params = new URLSearchParams(window.location.search);
        return params.get('id');
    }

    function val(v) {
        if (v === null || v === undefined || String(v).trim() === '') {
            return '<span class="empty">—</span>';
        }
        return String(v)
            .replace(/&/g, '&amp;')
            .replace(/</g, '&lt;')
            .replace(/>/g, '&gt;')
            .replace(/"/g, '&quot;')
            .replace(/'/g, '&#x27;');
    }

    function section(icon, title, rows) {
        const rowsHtml = rows.map(([label, value]) => `
            <div class="field-row">
                <div class="field-label">${label}</div>
                <div class="field-value">${val(value)}</div>
            </div>
        `).join('');
        return `
            <div class="order-section">
                <h2><i class="${icon}"></i> ${title}</h2>
                ${rowsHtml}
            </div>
        `;
    }

    async function loadOrder() {
        const id = getMissionId();
        const content = document.getElementById('mainContent');

        if (!id) {
            content.innerHTML = '<p class="error-msg"><i class="fas fa-exclamation-triangle"></i> No mission ID specified.</p>';
            return;
        }

        try {
            const res = await fetch(`/api/mission_details/${id}`);
            if (!res.ok) throw new Error(`HTTP ${res.status} – ${res.statusText || 'Failed to load mission details'}`);
            const m = await res.json();

            document.getElementById('headerTitle').textContent = m.objective || m.name || id;
            document.title = 'ORDER – ' + (m.objective || id);

            const d = m.data || {};
            const statusClass = `status-${m.status || 'ONGOING'}`;

            const metaBar = `
                <div class="order-section">
                    <h2><i class="fas fa-bullseye"></i> Mission Overview</h2>
                    <div class="meta-bar">
                        <span><strong>Date:</strong> ${val(d.date || m.date)}</span>
                        <span><strong>AO:</strong> ${val(d.location || m.location)}</span>
                        <span><strong>Start:</strong> ${val(d.start_time)}</span>
                        <span><strong>End:</strong> ${val(d.deadline)}</span>
                        <span><strong>Status:</strong> <span class="${statusClass}">${m.status || '—'}</span></span>
                    </div>
                </div>
            `;

            const gesamtbefehl = section(
                'fas fa-file-alt', 'Gesamtbefehl',
                [['Gesamtbefehl', d.gesamtbefehl]]
            );

            const lage = `
                <div class="order-section">
                    <h2><i class="fas fa-map-marked-alt"></i> Lage</h2>
                    <div class="field-row">
                        <div class="field-label">Feind</div>
                        <div class="field-value">${val(d.lage_feind)}</div>
                    </div>
                    <div class="field-row">
                        <div class="field-label">Eigene Kräfte</div>
                        <div class="field-value">${val(d.lage_eigene)}</div>
                    </div>
                    <div class="field-row">
                        <div class="field-label">Unterstellungen / Abgaben</div>
                        <div class="field-value">${val(d.lage_unterstellungen)}</div>
                    </div>
                </div>
            `;

            const auftrag = section(
                'fas fa-crosshairs', 'Auftrag',
                [['Auftrag', d.auftrag]]
            );

            const durchfuehrung = `
                <div class="order-section">
                    <h2><i class="fas fa-chess-knight"></i> Durchführung</h2>
                    <div class="field-row">
                        <div class="field-label">Wie?</div>
                        <div class="field-value">${val(d.durchf_wie)}</div>
                    </div>
                    <div class="field-row">
                        <div class="field-label">Plan</div>
                        <div class="field-value">${val(d.durchf_plan)}</div>
                    </div>
                    <div class="field-row">
                        <div class="field-label">Koordination</div>
                        <div class="field-value">${val(d.durchf_koordination)}</div>
                    </div>
                </div>
            `;

            const versorgung = `
                <div class="order-section">
                    <h2><i class="fas fa-box-open"></i> Versorgung</h2>
                    <div class="field-row">
                        <div class="field-label">Pausenzeiten und Verhalten</div>
                        <div class="field-value">${val(d.vers_pausenzeiten)}</div>
                    </div>
                    <div class="field-row">
                        <div class="field-label">Verpflegung</div>
                        <div class="field-value">${val(d.vers_verpflegung)}</div>
                    </div>
                </div>
            `;

            const verbindung = `
                <div class="order-section">
                    <h2><i class="fas fa-radio"></i> Verbindung</h2>
                    <div class="field-row">
                        <div class="field-label">Kanäle / Prüfen!</div>
                        <div class="field-value">${val(d.verb_kanaele)}</div>
                    </div>
                    <div class="field-row">
                        <div class="field-label">Gruppennamen</div>
                        <div class="field-value">${val(d.verb_gruppen)}</div>
                    </div>
                    <div class="field-row">
                        <div class="field-label">Kdo – Wo?</div>
                        <div class="field-value">${val(d.verb_kdo_wo)}</div>
                    </div>
                </div>
            `;

            // Build attachments section
            const attachments = d.attachments || [];
            let attachmentsHtml = '';
            if (attachments.length > 0) {
                const items = attachments.map(a => {
                    const isImage = /\.(jpg|jpeg|png|gif|webp|bmp|svg)$/i.test(a.url);
                    if (isImage) {
                        return `<div class="attachment-thumb">
                            <a href="${val(a.url)}" target="_blank">
                                <img src="${val(a.url)}" alt="${val(a.original_name)}">
                            </a>
                            <div class="attachment-label">${val(a.original_name)}</div>
                        </div>`;
                    }
                    return `<a class="attachment-link" href="${val(a.url)}" target="_blank">
                        <i class="fas fa-file-pdf"></i> ${val(a.original_name)}
                    </a>`;
                }).join('');
                attachmentsHtml = `
                    <div class="order-section">
                        <h2><i class="fas fa-paperclip"></i> Anhänge / Dokumente</h2>
                        <div class="attachment-grid">${items}</div>
                    </div>
                `;
            }

            content.innerHTML = metaBar + gesamtbefehl + lage + auftrag + durchfuehrung + versorgung + verbindung + attachmentsHtml;

        } catch (e) {
            content.innerHTML = `<p class="error-msg"><i class="fas fa-exclamation-triangle"></i> Error loading mission: ${e.message}</p>`;
        }
    }

    document.addEventListener('DOMContentLoaded', loadOrder);
</script>

</body>
</html>
